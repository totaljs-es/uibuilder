@{layout('')}

<!DOCTYPE html>
<html>
<head>
	<title>Total.js UI Builder</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<meta http-equiv="X-UA-Compatible" content="IE=10" />
	<meta name="robots" content="all,follow" />
	<link href="@{'%cdn'}/spa.min@19.css" rel="stylesheet" type="text/css" />
	<script src="@{'%cdn'}/spa.min@19.js"></script>
	<script src="@{REPO.ui}"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
	@{import('default.css + ui.css', 'ui.js + uibuilder.js')}
</head>
<body>

	<ui-component name="LAZY menu" config="style:2"></ui-component>
	<ui-component name="LAZY icons"></ui-component>
	<ui-component name="LAZY directory" config="placeholder:@(Search)"></ui-component>
	<ui-component name="LAZY approve" config="cancel:@(Cancel)"></ui-component>
	<ui-component name="LAZY colorpicker"></ui-component>
	<ui-component name="LAZY datepicker"></ui-component>
	<ui-component name="LAZY floatinginput"></ui-component>
	<ui-component name="LAZY notify" config="position:bottom right"></ui-component>
	<ui-component name="LAZY clipboard"></ui-component>
	<ui-component name="LAZY fileuploader"></ui-component>
	<ui-component name="LAZY imageuploader"></ui-component>
	<ui-component name="LAZY floatingbox"></ui-component>

	<ui-component name="exec"></ui-component>
	<ui-component name="locale"></ui-component>
	<ui-component name="loading"></ui-component>
	<ui-component name="edit"></ui-component>

	<ui-bind path="app.ready" config="visible" class="invisible block">
		<ui-component name="layout" path="common.layout" config="parent:window">

			<script type="text/plain">
				{
					top: { size: 44 },
					left: { size: 220, resize: true },
					main: {}
				}
			</script>

			<section data-type="top">
				<div class="header">

					<div class="pull-right">
						<a href="https://docs.totaljs.com/uibuilder/" title="Documentation: Total.js Platform" target="_blank" class="special"><i class="ti ti-book"></i></a>
					</div>
					<div class="pull-right">
						<a href="/" title="@(Create a new app)" target="_blank"><i class="ti ti-plus-circle green"></i></a>
					</div>

					<div>
						<button class="apply exec" data-exec="uibuilder_save"><i class="ti ti-save"></i><span>@(SAVE)</span></button>
					</div>

					<div style="margin-right:8px">
						<button class="exec" data-exec="uibuilder_publish" title="@(Publish)"><i class="ti ti-box"></i></button>
						<button is="is-button" path="app.schema.editor.render" config="enable" class="exec" data-exec="uibuilder_render" title="@(Preview)" disabled><i class="ti ti-flask"></i></button>
						<button class="exec" data-exec="uibuilder_settings" title="@(Global settings)"><i class="ti ti-cog"></i></button>
					</div>

					<button class="exec" data-exec="uibuilder_device" title="@(Display settings)"><i class="ti ti-window"></i></button>
					<button class="exec" data-exec="uibuilder_io" title="@(Inputs / Outputs)"><i class="ti ti-code-branch"></i></button>
					<button class="exec" data-exec="uibuilder_darkmode" title="@(Toggle between light/dark mode)" is="is-bind" path="common.darkmode" config=".selected"><i class="ti ti-adjust"></i></button>
					<button class="exec" data-exec="uibuilder_redraw" title="@(Re-load objects)"><i class="ti ti-sync"></i></button>
				</div>
			</section>

			<section data-type="left">
				<ui-component name="searchinput" path="%searchobjects" config="type:search;placeholder:Search components;autofocus:2"></ui-component>
				<div style="margin:5px 10px 0 14px" class="fs11">
					<div><span class="exec link" data-exec="uibuilder_objects"><i class="ti ti-cloud-download mr5"></i>@(Download)</span></div>
				</div>
				<ui-component name="search" path="%searchobjects" config="selector:figure">
					<ui-bind path="common.groups" config="template" class="block objects">
						<script type="text/html">
						{{ foreach g in value }}
							<div class="caption">{{ g.id }}</div>
							{{ foreach m in g.items }}
							<figure draggable="true" class="draggable" data-id="{{ m.id }}" data-search="{{ m.name }}">
								<i class="{{ m.icon }}"></i>
								<div class="name">{{ m.name }}</div>
							</figure>
							{{ end }}
						{{ end }}
						</script>
					</ui-bind>
				</ui-component>
			</section>

			<section data-type="main">
				<ui-component name="viewbox" path="app" config="parent:window;margin:44;scrollbarshadow:1">
					<div id="dappcontainer">
						<ui-component id="dapp" name="uibuildereditor" config="exec:func;ondrop:drop_object;dblclick:opensettings"></ui-component>
					</div>
				</ui-component>
			</section>

		</ui-component>

	</ui-bind>

	<ui-component name="box" path="common.form" config="if:settingsform;width:840;title:@(Settings);icon:ti ti-cog;submit:settings_submit;scrollbar:0;reload:settings_reload;autofocus:1">
		<ui-component name="stash" path="settingsform.objectid" config="load:settings_load" class="settingsform"></ui-component>
	</ui-component>

	<ui-component name="importer" path="common.form" config="if:appsettingsform;url:/forms/settings.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:templatesform;url:/forms/templates.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:objectsform;url:/forms/objects.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:ioform;url:/forms/io.html"></ui-component>
	<ui-component name="importer" path="common.form2" config="if:formlink;url:/forms/link.html"></ui-component>
	<ui-component name="importer" path="common.form2" config="if:formattr;url:/forms/attr.html"></ui-component>

	<form id="uibuilderrender" method="POST" target="_blank">
		<input name="data" type="hidden" />
	</form>

	<script>

		var common = {};

		common.objects = [];
		common.paths = '';
		common.codes = '';

		CACHEPATH('common.darkmode', '1 year');

		ON('ready', function() {
			common.darkmode && $('body').aclass('ui-dark');
		});

		ON('@flag showloading', function() {
			SETTER('loading/show');
		});

		ON('@flag hideloading', function() {
			SETTER('loading/hide', 500);
		});

		ON('ERROR', function(err) {
			if (err instanceof Array)
				err = err[0].error || err[0].message;
			else
				err = err.toString();
			SETTER('notify/warning', err || 'Unexpected error');
		});

		function settings_reload(com) {

			var id = settingsform.objectid;
			var data = settingsform[id];
			var obj = app.objects[id];

			com.reconfigure({ title: '@(Settings:) ' + obj.name });

			if (!data.name)
				data.name = obj.name;

			EXEC('settingsform.' + id + '/reload', data);
		}

		function settings_load(id, next) {
			var obj = app.objects[id];
			if (obj) {

				var done = function(response) {

					if (typeof(response) !== 'string')
						response = '';

					var beg = response.indexOf('<scr' + 'ipt>');
					if (beg !== -1) {
						response = response.replace(/PLUGIN\((\s)?function/g, 'PLUGIN(\'settingsform.' + id + '\', function');
						var end = response.indexOf('</scr' + 'ipt>', beg + 8);
						var scr = response.substring(beg + 8, end).trim();
						response = response.substring(0, beg) + response.substring(end);
						new Function(scr)();
					}

					next('<ui-plugin path="settingsform.{0}"><ui-component name="ready" config="delay:300" class="invisible"><ui-component name="viewbox" path="common.form" config="scrollbar:1;scrollbarshadow:1;margin:70;parent:auto"><div class="padding main npb"><div class="grid-2"><div class="m"><ui-component name="input" path="?.name" config="required:1;innerlabel:1;placeholder:@(Object name)">@(Name)</ui-component><div class="help">ID: <ui-bind path="?.$id" config="text" class="b monospace"></ui-bind></div></div><div class="m"><ui-component name="input" path="?.path" config="dirsource:DEF.cl.paths;dircustom:1;dirraw:1;dirplaceholder:@(Search path or enter custom);monospace:1;innerlabel:1;placeholder:path.to.property">@(Path for reading/writing)</ui-component><div class="help"><span class="exec link" data-exec="settings_clearpath"><i class="ti ti-clean mr5"></i>@(Clear path)</span></div></div></div></div>{1}</ui-component><nav><ui-component name="validate" path="?" class="buttons"><button name="submit" disabled><i class="ti ti-check-circle"></i>@(SUBMIT)</button><button name="cancel">@(Cancel)</button></ui-component></nav></ui-component></ui-plugin>'.format(id, response));
				};

				if (obj.settings) {
					if (obj.settings.indexOf('<') === -1)
						AJAX('GET ' + obj.settings, done);
					else
						done(obj.settings);
				} else
					done(obj.settings);

			} else
				next('');
		}

		function settings_clearpath(el) {
			el.scope().set('path', '');
		}

		function settings_submit(hide) {
			var data = CLONE(settingsform[settingsform.objectid]);
			delete data.$id;
			var instance = app.instances.findItem('id', settingsform.id);
			COPY(data, instance.config);
			instance.emit('configure', instance.config);
			app.refreshio();
			uibuilder_rebuildpaths();
			hide();
		}

		ON('ready', function() {

			var url = NAV.query.url;

			if (!url) {
				SET('common.form', 'templatesform');
				return;
			}

			AJAX('GET ' + url, function(response) {
				UIBuilder.data = response;
				uibuilder_redraw();
			});
		});

		function uibuilder_io() {
			SET('common.form', 'ioform');
		}

		function uibuilder_darkmode() {
			var el = $('body');
			var c = 'ui-dark';
			el.tclass(c);
			SET('common.darkmode', el.hclass(c));
		}

		function uibuilder_rebuildpaths() {

			DEF.cl.paths = DEF.cl.paths.remove('internal', true);

			var arr = [];

			for (var instance of app.instances) {
				if (instance.config.path)
					arr.push({ id: '@' + instance.id, name: '<span class="badge badge-small mr5 badge-gray monospace">object</span>' + instance.config.name + '<span class="fs11 silver ml5">' + instance.id + '</span>', sort: instance.config.name, internal: true });
			}

			arr.quicksort('sort');
			DEF.cl.paths.push.apply(DEF.cl.paths, arr);

			UPD('DEF.cl.paths');
		}

		function uibuilder_redraw(el) {

			if (el) {
				var cls = 'ti-spin';
				el.find('i').aclass(cls).rclass(cls, 2000);
				UIBuilder.data.children = app.stringify().children;
			}

			SETTER('loading/show');

			common.paths = '';
			common.codes = '';

			UIBuilder.build('#dapp', UIBuilder.data, function(response) {

				SETTER('stash/clear');
				SETTER('loading/hide', 1000);

				W.app = response;

				var arr = [];
				var groups = {};

				for (var key in response.objects) {
					var obj = response.objects[key];
					var g = obj.group || '$';
					if (groups[g])
						groups[g].push(obj);
					else
						groups[g] = [obj];
					arr.push(obj);
				}

				var arr2 = [];

				for (var key in groups)
					arr2.push({ id: key === '$' ? '' : key, items: groups[key] });

				SET('common.objects', arr);
				SET('common.groups', arr2);
				UPD('app');
			});
		}

		function opensettings(el) {
			var obj = el[0].uibuilder;
			var objectid = obj.object.id;

			var config = CLONE(obj.config);
			config.$id = obj.id;

			SET('settingsform.id', obj.id);
			SET('settingsform.objectid', objectid);
			SET('settingsform.' + objectid + ' @reset', config);
			SET('common.form', 'settingsform');
		}

		function drop_object(meta) {

			var parent = meta.container.closest('.UI_object');
			var parentid = parent.attrd('id');
			var containerindex = meta.container.attrd('index');
			var target = meta.target.hclass('UI_object') ? meta.target : meta.target.closest('.UI_object');

			if (!target[0])
				return;

			var position = target[0] === parent[0] ? null : (NODEINDEXOF(target[0]) + 1);
			var config;
			var instance = meta.element[0].uibuilder;

			// Existing object
			if (instance) {

				// Same element
				if (instance.dom === target[0])
					return;

				var data = app.stringify(instance.element);
				var metadata = data.children;
				app.add(parentid, containerindex, metadata, position);
				meta.element.remove();
				app.clean();

			} else
				app.add(parentid, containerindex, ATTRD(meta.element), position);
		}

		function uibuilder_compile(callback) {

			SETTER('loading/show');

			var meta = CLONE(app.schema);
			var data = app.stringify(function(item) {
				return !!item.object.render;
			});

			meta.children = data.children;
			meta.inputs = app.inputs;
			meta.outputs = app.outputs;

			var used = {};

			for (var instance of app.instances) {
				if (instance.object.render)
					used[instance.object.id] = instance.object.render;
			}

			if (meta.editor && meta.editor.download) {
				var arr = Object.keys(used);
				arr.wait(function(key, next) {
					var obj = app.objects[key];
					AJAX('GET ' + obj.render, function(response) {
						var parsed = UIBuilder.parsehtml(response);
						used[key] = 'base64 ' + btoa(encodeURIComponent(response));
						next();
					});
				}, function() {
					meta.objects = used;
					callback(meta);
				});
			} else {
				meta.objects = used;
				callback(meta);
			}
		}

		function uibuilder_publish() {
			SETTER('approve/show', '@(Are you sure you want to publish design?)', '"ti ti-check-circle" @(PUBLISH)', function() {
				uibuilder_compile(function(meta) {
					var data = meta.editor;
					delete meta.editor;
					if (app.schema.editor && app.schema.editor.publish) {
						AJAX('POST ' + data.publish + ' urlencoded', { data: JSON.stringify(meta) }, ERROR(ASETTER('notify/success @hideloading', '@(Done, published!)')));
					} else {
						var blob = new Blob([JSON.stringify(meta, null, '\t')], { type: 'text/plain; charset=utf-8' });
						saveAs(blob, meta.name + '_render.json');
						SETTER('loading/hide', 1000);
					}
				});
			});
		}

		function uibuilder_settings() {

			var path = 'appsettingsform';
			var data = {};
			var schema = app.schema;

			data.id = schema.id;
			data.name = schema.name;
			data.title = schema.title;
			data.author = schema.author;
			data.icon = schema.icon;
			data.type = schema.type;
			data.version = schema.version;
			data.args = schema.args;
			data.editor = schema.editor ? CLONE(schema.editor) : {};
			data.description = schema.description;

			SET('appsettingsform @reset', data);
			SET('common.form', path);
		}

		function uibuilder_render() {
			if (app.schema.editor && app.schema.editor.render) {
				uibuilder_compile(function(meta) {
					SETTER('loading/hide', 1000);
					var data = meta.editor;
					delete meta.editor;
					var form = $('#uibuilderrender');
					form.attr('action', data.render);
					form.find('input').val(JSON.stringify(meta));
					form.submit();
				});
			}
		}

		function uibuilder_device(el) {
			var opt = {};
			var sel = common.device || 'auto';
			opt.element = el;
			opt.align = 'left';
			opt.items = [];
			opt.items.push({ id: 'xs', name: 'Extra small display', icon: 'ti ti-mobile' });
			opt.items.push({ id: 'sm', name: 'Small display', icon: 'ti ti-tablet' });
			opt.items.push({ id: 'md', name: 'Medium display', icon: 'ti ti-laptop' });
			opt.items.push({ id: 'lg', name: 'Large display', icon: 'ti ti-desktop' });
			opt.items.push('-');
			opt.items.push({ id: 'auto', name: 'Current browser', icon: 'ti ti-window' });

			if (sel) {
				for (var item of opt.items)
					item.selected = sel === item.id;
			}

			opt.callback = function(selected) {
				var container = $('#dappcontainer');
				container.rclass2('dm-');
				container.tclass('dm', selected.id !== 'auto');
				container.aclass('dm-' + selected.id);
				SET('common.device', selected.id);
				el.find('i').rclass2('fa').aclass(selected.icon);
			};
			SETTER('menu/show', opt);
		}

		function uibuilder_objects() {
			SET('common.form', 'objectsform');
		}

		function uibuilder_save() {

			var meta = CLONE(app.schema);
			var data = app.stringify();

			meta.children = data.children;
			meta.inputs = app.inputs;
			meta.outputs = app.outputs;

			if (meta.editor && meta.editor.save) {
				SETTER('approve/show', '@(Are you sure you want to save design?)', '"ti ti-check-circle" @(SAVE)', function() {
					SETTER('loading/show');
					AJAX('POST ' + meta.editor.save + ' urlencoded', { data: JSON.stringify(meta) }, ERROR(ASETTER('notify/success @hideloading', '@(Done, saved!)')));
				});
			} else {
				var blob = new Blob([JSON.stringify(meta, null, '\t')], { type: 'text/plain; charset=utf-8' });
				saveAs(blob, meta.name + '_editor.json');
				SETTER('loading/hide', 1000);
			}
		}

		WATCH('app.schema.editor.paths', function(path, value) {

			if (value == null)
				value = '';

			if (common.paths !== value) {
				common.paths = value;
				AJAX('GET ' + value, function(response) {

					if (response instanceof Array) {

						response = response.remove(item => !item || !item.name);

						for (var item of response) {
							if (item.type)
								item.name = item.name.encode() + (item.type ? '<span class="badge badge-small ml5 monospace" style="background:{0}">{1}</span>'.format(Thelpers.color(item.type), item.type) : '');
							else
								item.name = item.name.encode();
						}
					} else
						response = [];

					SET('DEF.cl.paths', response);
					uibuilder_rebuildpaths();
				});
			} else {
				SET('DEF.cl.paths', []);
				uibuilder_rebuildpaths();
			}
		});

		WATCH('app.schema.editor.codes', function(path, value) {

			if (value == null)
				value = '';

			if (common.codes !== value) {
				common.codes = value;
				AJAX('GET ' + value, function(response) {
					if (response instanceof Array)
						response = response.remove(item => !item || !item.name);
					else
						response = [];
					SET('DEF.cl.codes', response);
				});
			} else
				SET('DEF.cl.codes', []);

		});

		UIBuilder.on('io', function(app) {
			SET('DEF.cl.inputs', app.inputs);
			SET('DEF.cl.outputs', app.outputs);
			SET('DEF.cl.list', app.list);
		});

		UIBuilder.on('attr', function(el, callback) {
			el = $(el);
			var model = {};
			model.element = el;
			model.title = el.attr('title') || '';
			model.isimage = el[0].tagName === 'IMG';
			model.isiframe = el[0].tagName === 'IFRAME';
			model.id = el.attr('id') || '';
			model.width = el.attr('width') || '';
			model.height = el.attr('height') || '';
			model.src = el.attr('src') || '';
			model.css = el.attr('style') || '';
			model.cls = el.attr('class') || '';
			model.callback = () => callback(model.element);
			SET('formattr', model);
			SET('common.form2', 'formattr');
		});

		UIBuilder.on('icon', function(el, callback) {
			var opt = {};
			opt.element = $(el);
			opt.empty = true;
			opt.callback = function(val) {
				opt.element.rclass2('ti').aclass(val);
				callback(opt.element, val);
			};
			EXEC('-icons/show', opt);
		});

		UIBuilder.on('link', function(el, callback) {
			el = $(el);
			var model = {};
			model.element = el;
			model.href = el.attr('href');
			model.target = el.attr('_target') || '';
			model.callback = () => callback(model.element);
			SET('formlink', model);
			SET('common.form2', 'formlink');
		});

		UIBuilder.on('make', function(instance) {

			if (!instance.protected) {

				instance.element.attr('draggable', true);
				instance.element.on('contextmenu', function(e) {

					e.preventDefault();
					e.stopPropagation();

					var opt = {};
					opt.x = e.pageX;
					opt.y = e.pageY;
					opt.items = [];
					opt.items.push(instance.object.name);
					opt.items.push({ id: 'settings', name: '@(Settings)', classname: 'b', icon: 'ti ti-cog' });
					opt.items.push({ id: 'gap', name: '@(Toggle gap)', selected: instance.element.hclass('UI_gap'), icon: 'ti ti-caret-square-down' });

					opt.items.push('-');
					opt.items.push({ id: 'remove', name: '@(Remove)', icon: 'ti ti-remove red' });
					opt.callback = function(selected) {
						switch (selected.id) {
							case 'gap':
								instance.element.tclass('UI_gap');
								break;
							case 'settings':
								opensettings(instance.element);
								break;
							case 'remove':
								instance.remove();
								break;
						}

					};

					SETTER('menu/show', opt);
				});
			}

		});

	</script>

</body>
</html>