@{layout('')}

<!DOCTYPE html>
<html>
<head>
	<title>Total.js UI Builder</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<meta http-equiv="X-UA-Compatible" content="IE=10" />
	<meta name="robots" content="all,follow" />
	<link href="@{'%cdn'}/spa.min@19.css" rel="stylesheet" type="text/css" />
	<script src="@{'%cdn'}/spa.min@19.js"></script>
	<script src="@{REPO.ui}"></script>
	@{import('default.css + ui.css', 'ui.js + func.js + uibuilder.js')}
</head>
<body>

	<ui-component name="LAZY menu" config="style:2"></ui-component>
	<ui-component name="LAZY icons"></ui-component>
	<ui-component name="LAZY directory" config="placeholder:@(Search)"></ui-component>
	<ui-component name="LAZY approve" config="cancel:@(Cancel)"></ui-component>
	<ui-component name="LAZY colorpicker"></ui-component>
	<ui-component name="LAZY datepicker"></ui-component>
	<ui-component name="LAZY floatinginput"></ui-component>
	<ui-component name="LAZY notify" config="position:bottom right"></ui-component>
	<ui-component name="LAZY clipboard"></ui-component>
	<ui-component name="LAZY fileuploader"></ui-component>
	<ui-component name="LAZY floatingbox"></ui-component>
	<ui-component name="LAZY sounds" config="volume:10"></ui-component>
	<ui-component name="LAZY message" config="style:2"></ui-component>
	<ui-component name="LAZY floatinginput"></ui-component>
	<ui-component name="LAZY filesaver"></ui-component>

	<ui-component name="windows" path="common.windows" config="zindex:30"></ui-component>
	<ui-component name="markdown"></ui-component>
	<ui-component name="exec"></ui-component>
	<ui-component name="locale"></ui-component>
	<ui-component name="loading"></ui-component>
	<ui-component name="shortcuts"></ui-component>
	<ui-component name="edit"></ui-component>

	<ui-bind path="app.ready" config="visible" class="invisible block">
		<ui-component name="layout" path="common.layout" config="parent:window">

			<script type="text/plain">
				{
					top: { size: 44 },
					left: { size: 220, resize: true },
					main: {}
				}
			</script>

			<section data-type="top">
				<div class="header">

					<span class="beta">beta</span>

					<ui-bind path="common.iframe" config="show" class="hidden pull-right">
						<button class="exec red" data-exec="uibuilder_close" title="@(Close)"><i class="ti ti-times"></i></button>
					</ui-bind>

					<div class="pull-right">
						<a href="https://docs.totaljs.com/uibuilder/" title="@(Documentation: Total.js Platform)" target="_blank" class="special"><i class="ti ti-book"></i></a>
					</div>

					<div>
						<button class="apply exec" data-exec="uibuilder_save"><i class="ti ti-save"></i><span>@(SAVE)</span></button>
					</div>

					<div style="margin-right:8px">
						<button class="exec" data-exec="uibuilder_render" title="@(Preview)" style="background-color:#FFEBFE"><i class="ti ti-flask"></i></button>
						<ui-bind path="app.schema.editor.autopublish" config="hide:value">
							<button class="exec" data-exec="uibuilder_publish" title="@(Publish)"><i class="ti ti-box"></i></button>
						</ui-bind>
						<ui-bind path="app.schema.editor.settings" config="show:value!=false&&value!=0">
							<button class="exec" data-exec="uibuilder_settings" title="@(Global settings)"><i class="ti ti-cog"></i></button>
						</ui-bind>
					</div>

					<button class="exec" data-exec="uibuilder_device" title="@(Display settings)"><i class="ti ti-window"></i></button>
					<button class="exec" data-exec="uibuilder_io" title="@(Inputs / Outputs)"><i class="ti ti-code-branch"></i></button>
					<!--
					<button class="exec" data-exec="uibuilder_darkmode" title="@(Toggle between light/dark mode)" is="is-bind" path="common.darkmode" config=".selected"><i class="ti ti-adjust"></i></button>
					-->
					<button class="exec" data-exec="uibuilder_redraw" title="@(Re-load components)"><i class="ti ti-sync"></i></button>
				</div>
			</section>

			<section data-type="left">
				<ui-component name="searchinput" path="%searchcomponents" config="type:search;placeholder:@(Search components);autofocus:2"></ui-component>
				<div style="margin:5px 10px 8px 14px" class="fs11">
					<div><span class="exec link" data-exec="uibuilder_components"><i class="ti ti-cloud-download mr5"></i>@(Download components)</span></div>
				</div>
				<ui-component name="viewbox" config="parent:window;margin:104;scrollbarshadow:1">
					<ui-component name="search" path="%searchcomponents" config="selector:figure">
						<ui-bind path="common.groups" config="template" class="block components">
							<script type="text/html">
							{{ foreach g in value }}
								<div class="caption">{{ g.id }}</div>
								{{ foreach m in g.items }}
								<figure draggable="true" class="draggable exec exec3" data-exec3="uibuilder_contextmenu" data-exec="component_readme" data-id="{{ m.id }}" data-search="{{ m.name }}">
									<i class="{{ m.icon }}"></i>
									<div class="name">{{ m.name }}</div>
								</figure>
								{{ end }}
							{{ end }}
							</script>
						</ui-bind>
					</ui-component>
					<br />
				</ui-component>
			</section>

			<section data-type="main">
				<ui-component name="viewbox" path="app" config="parent:window;margin:44;scrollbarshadow:1;visibleX:1;visibleY:1">
					<div id="dappcontainer">
						<ui-component id="dapp" name="uibuildereditor" config="exec:func;ondrop:component_drop;dblclick:opensettings"></ui-component>
					</div>
				</ui-component>
			</section>

		</ui-component>

	</ui-bind>

	<ui-component name="box" path="common.form" config="if:settingsform;width:840;title:@(Settings);icon:ti ti-cog;submit:settings_submit;scrollbar:0;reload:settings_reload;autofocus:1">
		<ui-component name="stash" path="settingsform.componentid" config="load:settings_load" class="settingsform"></ui-component>
	</ui-component>

	<ui-component name="importer" path="common.form" config="if:appsettingsform;url:/forms/settings.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:templatesform;url:/forms/templates.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:componentsform;url:/forms/components.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:ioform;url:/forms/io.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:formimport;url:/forms/import.html"></ui-component>
	<ui-component name="importer" path="common.form2" config="if:formlink;url:/forms/link.html"></ui-component>
	<ui-component name="importer" path="common.form2" config="if:formattr;url:/forms/attr.html"></ui-component>
	<ui-component name="importer" path="common.form2" config="if:formtotaldb;url:/forms/totaldb.html"></ui-component>

	<form id="uibuilderrender" method="POST" target="_blank">
		<input name="data" type="hidden" />
	</form>

	<script>

		var common = {};
		var settingsform = {};

		DEF.language = '';

		UIBuilder.editor = true;

		common.windows = [];
		common.components = [];
		common.iframeapps = [];
		common.paths = '';
		common.codes = '';
		common.apps = '';
		common.views = '';

		CACHEPATH('common.darkmode', '1 year');

		ON('@flag showloading', function() {
			SETTER('loading/show');
		});

		ON('@flag hideloading', function() {
			SETTER('loading/hide', 500);
		});

		ON('ERROR', function(err) {
			if (err instanceof Array)
				err = err[0].error || err[0].message;
			else
				err = err.toString();
			SETTER('notify/warning', err || 'Unexpected error');
		});

		function settings_reload(form) {

			var id = settingsform.componentid;
			var data = settingsform[id];
			var com = app.components[id];

			form.reconfigure({ title: '@(Settings:) ' + com.name });

			if (!data.name)
				data.name = com.name;

			EXEC('settingsform.' + id + '/reload', data);
		}

		$(W).on('message', function(e) {
			e = e.originalEvent;

			var msg = e.data;

			if (typeof(msg) === 'string')
				msg = PARSE(msg);

			if (!msg.uibuilder)
				return;

			switch (msg.TYPE) {
				case 'init':

					UIBuilder.origin = e.origin;
					common.upload = msg.upload;
					common.iframeapps = msg.apps || [];
					common.iframeviews = msg.views || [];
					common.iframecodes = msg.codes || [];
					common.iframepaths = msg.paths || [];
					DEF.cl.usergroups = msg.groups || [];

					SET('DEF.cl.views', common.iframeviews.slice(0));
					SET('DEF.cl.paths', common.iframepaths.slice(0));
					SET('DEF.cl.codes', common.iframecodes.slice(0));
					SET('DEF.cl.apps', common.iframeapps.slice(0));

					if (msg.data && msg.data.id) {
						UIBuilder.data = msg.data;
						uibuilder_redraw();
					} else
						SET('common.form', 'templatesform');
					break;
			}

		});

		function settings_load(id, next) {
			var com = app.components[id];
			if (com) {

				var done = function(response) {

					if (typeof(response) !== 'string')
						response = '';

					response = ADAPT(null, null, response.replace(/CLASS/g, com.cls));

					var beg = response.indexOf('<scr' + 'ipt>');
					if (beg !== -1) {
						response = response.replace(/PLUGIN\((\s)?function/g, 'PLUGIN(\'settingsform.' + id + '\', function');
						var end = response.indexOf('</scr' + 'ipt>', beg + 8);
						var scr = response.substring(beg + 8, end).trim();
						response = response.substring(0, beg) + response.substring(end);
						new Function(scr)();
					}

					next('<ui-plugin path="settingsform.{0}" config="init:?/reload" class="{2}_settings"><ui-component name="ready" config="delay:300" class="invisible"><ui-component name="viewbox" path="common.form" config="scrollbar:1;scrollbarshadow:1;margin:70;parent:auto"><div class="padding main npb"><div class="grid-2"><div class="m"><ui-component name="input" path="?.name" config="required:1;innerlabel:1;placeholder:@(Component name)">@(Name)</ui-component><div class="help">ID: <ui-bind path="?.$id" config="text" class="b monospace"></ui-bind></div></div><div class="m"><ui-component name="input" path="?.path" config="dirsource:DEF.cl.paths;dircustom:1;dirraw:1;dirplaceholder:@(Search path or enter custom);monospace:1;innerlabel:1;placeholder:path.to.property">@(Path for reading/writing)</ui-component><div class="help"><span class="exec link" data-exec="settings_clearpath"><i class="ti ti-clean mr5"></i>@(Clear path)</span></div></div></div></div>{1}</ui-component><nav><ui-component name="validate" path="?" class="buttons"><button name="submit" disabled><i class="ti ti-check-circle"></i>@(SUBMIT)</button><button name="cancel">@(Cancel)</button></ui-component></nav></ui-component></ui-plugin>'.format(id, response, com.cls));
				};

				if (com.settings) {
					if (com.settings.indexOf('<') === -1)
						AJAX('GET ' + com.settings, done);
					else
						done(com.settings);
				} else
					done(com.settings);

			} else
				next('');
		}

		function settings_clearpath(el) {
			el.scope().set('path', '');
		}

		function settings_submit(hide) {
			var data = CLONE(settingsform[settingsform.componentid]);
			delete data.$id;
			var instance = app.instances.findItem('id', settingsform.id);
			instance.reconfigure(data);

			for (var item of app.instances)
				item.events.refresh && item.emit('refresh', { type: 'configure', item: instance });

			app.refreshio();
			hide();
		}

		ON('ready', function() {

			common.darkmode && $('body').aclass('ui-dark');

			if (top !== W) {
				// iframe
				SET('common.iframe', true);
				FUNC.send({ TYPE: 'ready' });
				return;
			}

			var url = NAV.query.url;

			if (!url) {
				SET('common.form', 'templatesform');
				return;
			}

			AJAX('GET ' + url, function(response, err) {
				if (err) {
					SET('common.form', 'templatesform');
					SETTER('message/warning @hideloading', 'Invalid source: ' + err);
				} else {
					UIBuilder.data = response;
					uibuilder_redraw();
				}
			});
		});

		function uibuilder_io() {
			SET('common.form', 'ioform');
		}

		function uibuilder_darkmode() {
			var el = $('body');
			var c = 'ui-dark';
			el.tclass(c);
			SET('common.darkmode', el.hclass(c));
		}

		function uibuilder_rebuildpaths() {
			common.rebuildpathstimeout && clearTimeout(common.rebuildpathstimeout);
			common.rebuildpathstimeout = setTimeout(uibuilder_rebuildpaths_force, 10);
		}

		function uibuilder_rebuildpaths_force() {

			common.rebuildpathstimeout = null;
			DEF.cl.paths = DEF.cl.paths.remove('internal', true);
			DEF.cl.datasource = [];

			var arr = [];

			for (var instance of app.instances) {
				if (instance.component.follow)
					arr.push({ id: '@' + instance.id, name: '<span class="badge badge-small mr5 badge-gray monospace">@(component)</span>' + instance.config.name + '<span class="fs11 silver ml5">' + instance.id + ' / ' + instance.component.name + '</span>', sort: instance.config.name, text: instance.config.name, internal: true });
			}

			arr.quicksort('sort');

			DEF.cl.paths.push.apply(DEF.cl.paths, arr);

			if (DEF.cl.views) {
				for (var view of DEF.cl.views)
					arr.push({ id: '#' + view.id, name: '<span class="badge badge-small mr5 badge-yellow monospace">@(view)</span>' + view.name, sort: view.name });
			}

			DEF.cl.datasource.push.apply(DEF.cl.datasource, DEF.cl.codes);
			DEF.cl.datasource.push.apply(DEF.cl.datasource, arr);


			UPD('DEF.cl.paths');
			UPD('DEF.cl.datasource');

			for (var instance of app.instances)
				instance.events.refresh && instance.emit('refresh', { type: 'paths' });
		}

		function uibuilder_redraw(el) {

			if (el) {
				if (el instanceof jQuery) {
					var cls = 'ti-spin';
					el.find('i').aclass(cls).rclass(cls, 2000);
				}
				UIBuilder.data.children = app.stringify().children;
			}

			SETTER('loading/show');

			common.paths = '';
			common.codes = '';
			common.views = '';

			UIBuilder.build('#dapp', UIBuilder.data, function(response) {

				SETTER('stash/clear');
				SETTER('loading/hide', 1000);

				W.app = response;

				var arr = [];
				var groups = {};

				for (var key in response.components) {
					var com = response.components[key];

					if (com.hidden)
						continue;

					var g = com.group || '$';
					if (groups[g])
						groups[g].push(com);
					else
						groups[g] = [com];
					arr.push(com);
				}

				var arr2 = [];

				for (var key in groups) {
					var items = groups[key];
					items.quicksort('name');
					arr2.push({ id: key === '$' ? '' : key, items: items });
				}

				arr2.quicksort('id');

				SET('common.components', arr);
				SET('common.groups', arr2);
				UPD('app');
			});
		}

		function opensettings(el) {
			var com = el[0].uibuilder;
			var componentid = com.component.id;

			var config = CLONE(com.config);
			config.$id = com.id;

			UIBuilder.selected = com;

			SET('settingsform.id', com.id);
			SET('settingsform.componentid', componentid);
			SET('settingsform.' + componentid + ' @reset', config);
			SET('common.form', 'settingsform');
		}

		function component_readme(el) {
			var id = ATTRD(el);
			var com = app.components[id];
			FUNC.readme(com.name, com.readme || '@(Without readme)');
		}

		function component_clone(instance) {

			var meta = app.stringify(instance.element).children;
			var index = 0;

			meta.id = 'cid' + Date.now().toString(36);

			var updateid = function(children) {
				for (var item of children) {
					for (var m of item) {
						m.id = 'cid' + Math.random().toString(36).substring(2).substring(0, 8);
						updateid(m.children);
					}
				}
			};

			updateid(meta.children);

			var parent = instance.parent.element;
			var parentid = parent.attrd('id');
			var containerindex = instance.element.closest('.UI_components').attrd('index');
			var target = instance.element;
			var position = target[0] === parent[0] ? null : (NODEINDEXOF(target[0]) + 1);
			app.add(parentid, containerindex, meta, position);
			app.clean();
		}

		function component_move(instance, up) {

			var meta = app.stringify(instance.element).children;
			var parent = instance.parent.element;
			var parentid = parent.attrd('id');
			var containerindex = instance.element.closest('.UI_components').attrd('index');
			var target = instance.element;
			var position = target[0] === parent[0] ? null : (NODEINDEXOF(target[0]) + (up ? -1 : 2));

			if (position === -1)
				return;

			app.add(parentid, containerindex, meta, position);
			instance.element.remove();
			app.clean();
		}

		function component_drop(meta) {

			var parent = meta.container.closest('.UI_component');
			var parentid = parent.attrd('id');
			var containerindex = meta.container.attrd('index');
			var target = meta.target.hclass('UI_component') ? meta.target : meta.target.closest('.UI_component');

			if (!target[0])
				return;

			var position = target[0] === parent[0] ? null : (NODEINDEXOF(target[0]) + 1);
			var config;
			var node = meta.element;

			if (!node.hclass('UI_component'))
				node = node.closest('.UI_component');

			instance = node[0] ? node[0].uibuilder : null;

			if (!meta.element.hclass('draggable') && !instance)
				return;

			// Existing component
			if (instance) {

				// Same element or child
				if (instance.dom === target[0] || instance.dom.contains(parent[0]))
					return;

				var data = app.stringify(instance.element);
				var metadata = data.children;
				app.add(parentid, containerindex, metadata, position);
				node.remove();
				app.clean();

			} else {

				var comid = ATTRD(meta.element);
				var com = app.components[comid];
				var metadata = null;

				if (com.floating) {
					var offset = $('#dappcontainer').offset();
					metadata = { x: meta.pageX - offset.left, y: meta.pageY - offset.top, zindex: app.zindex + 1 };
					parentid = app.instances[0].id;
				}

				app.add(parentid, containerindex, comid, position, null, metadata);
			}
		}

		function uibuilder_compile(callback) {

			SETTER('loading/show');

			var meta = CLONE(app.schema);
			var data = app.stringify(function(item) {
				return !!item.component.render;
			}, true);

			meta.children = data.children;
			meta.inputs = app.inputs;
			meta.outputs = app.outputs;

			var used = {};

			for (var instance of app.instances) {
				if (instance.component.render)
					used[instance.component.id] = (meta.editor.download && instance.component.render.indexOf('http') === -1 ? 'https://uibuilder.totaljs.com' : '') + instance.component.render;
			}

			if (meta.editor && meta.editor.download) {
				var arr = Object.keys(used);
				arr.wait(function(key, next) {
					var com = app.components[key];
					AJAX('GET ' + com.render, function(response) {
						var parsed = UIBuilder.parsehtml(response);
						used[key] = 'base64 ' + btoa(encodeURIComponent(response));
						next();
					});
				}, function() {
					meta.components = used;
					callback(meta);
				});
			} else {
				meta.components = used;
				callback(meta);
			}
		}

		function uibuilder_publish() {

			if (common.iframe) {
				uibuilder_compile(function(meta) {
					var data = meta.editor;

					if (meta.cssoutput)
						meta.css = meta.cssoutput;

					delete meta.editor;
					delete meta.cssoutput;
					delete meta.csspreview;
					SETTER('loading/hide', 500);
					FUNC.send({ TYPE: 'publish', data: meta });
				});
				return;
			}

			var compile = function() {
				uibuilder_compile(function(meta) {
					var data = meta.editor;

					if (meta.cssoutput)
						meta.css = meta.cssoutput;

					delete meta.editor;
					delete meta.cssoutput;
					delete meta.csspreview;

					if (app.schema.editor && app.schema.editor.publish) {
						AJAX('POST ' + data.publish + ' urlencoded', { data: JSON.stringify(meta) }, ERROR(ASETTER('notify/success @hideloading', '@(Done, published!)')));
					} else {
						SETTER('filesaver/save', meta.name + '_render.json', JSON.stringify(meta, null, '\t'));
						SETTER('loading/hide', 1000);
					}
				});
			};

			if (app.schema.editor.autopublish)
				compile();
			else
				SETTER('approve/show', '@(Are you sure you want to publish design?)', '"ti ti-check-circle" @(PUBLISH)', compile);
		}

		function uibuilder_settings() {

			var path = 'appsettingsform';
			var data = {};
			var schema = app.schema;

			data.id = schema.id;
			data.name = schema.name;
			data.title = schema.title;
			data.author = schema.author;
			data.icon = schema.icon;
			data.type = schema.type;
			data.group = schema.group;
			data.version = schema.version;
			data.args = schema.args;
			data.editor = schema.editor ? CLONE(schema.editor) : {};
			data.description = schema.description;
			data.css = schema.css;
			data.cssoutput = schema.cssoutput;
			data.csspreview = schema.csspreview;

			SET('appsettingsform @reset', data);
			SET('common.form', path);
		}

		function uibuilder_render() {
			uibuilder_compile(function(meta) {

				var data = meta.editor;

				if (meta.csspreview)
					meta.css = meta.csspreview;

				delete meta.editor;
				delete meta.cssoutput;
				delete meta.csspreview;

				if (common.iframe) {
					SETTER('loading/hide', 500);
					FUNC.send({ TYPE: 'render', data: meta });
					return;
				}

				if (data.render) {
					SETTER('loading/hide', 1000);
					var form = $('#uibuilderrender');
					form.attr('action', data.render || 'https://preview.totaljs.com');
					form.find('input').val(JSON.stringify(meta));
					form.submit();
				} else
					SETTER('message/warning @hideloading', '@(You do not have defined a render URL address)');
			});
		}

		function uibuilder_contextmenu(el, e) {
			var id = ATTRD(el);
			var opt = {};
			opt.x = e.pageX;
			opt.y = e.pageY;
			opt.align = 'left';
			opt.items = [];
			opt.items.push({ id: 'readme', name: '@(Read information)', icon: 'ti ti-info-circle blue' });
			opt.items.push({ id: 'remove', name: '@(Remove)', icon: 'ti ti-remove red' });
			opt.callback = function(selected) {
				switch (selected.id) {

					case 'readme':
						var com = app.components[id];
						FUNC.readme(com.name, com.readme || '@(Without readme)');
						break;

					case 'remove':
						var com = app.components[id];

						for (var item of app.instances) {
							if (item.component === com && item.protected) {
								SETTER('message/warning', "@(This component is protected, it can't be removed.)");
								return;
							}
						}

						SETTER('approve/show', '@(Are you sure you want to remove "{0}" component?)'.format(com.name), '"ti ti-remove" @(Remove)', function() {
							delete app.schema.components[id];
							uibuilder_redraw();
						});

						break;
				}
			};
			SETTER('menu/show', opt);
		}

		function uibuilder_device(el) {
			var opt = {};
			var sel = common.device || 'auto';
			opt.element = el;
			opt.align = 'left';
			opt.items = [];
			opt.items.push({ id: 'xs', name: '@(Extra small display)', icon: 'ti ti-mobile' });
			opt.items.push({ id: 'sm', name: '@(Small display)', icon: 'ti ti-tablet' });
			opt.items.push({ id: 'md', name: '@(Medium display)', icon: 'ti ti-laptop' });
			opt.items.push({ id: 'lg', name: '@(Large display)', icon: 'ti ti-desktop' });
			opt.items.push('-');
			opt.items.push({ id: 'auto', name: '@(Current browser)', icon: 'ti ti-window' });

			if (sel) {
				for (var item of opt.items)
					item.selected = sel === item.id;
			}

			opt.callback = function(selected) {
				var container = $('#dappcontainer');
				container.rclass2('dm-');
				container.tclass('dm', selected.id !== 'auto');
				container.aclass('dm-' + selected.id);
				SET('common.device', selected.id);
				el.find('i').rclass2('ti').aclass(selected.icon);
				UIBuilder.resize();
			};

			SETTER('menu/show', opt);
		}

		function uibuilder_components(el) {
			var opt = {};
			opt.element = el;
			opt.items = [];
			opt.items.push({ id: 'components', name: '@(Download components)', icon: 'ti ti-database', classname: 'b' });
			opt.items.push('-');
			opt.items.push({ id: 'add', name: '@(Import custom)', icon: 'ti ti-plus-circle green' });
			opt.callback = function(sel) {
				switch (sel.id) {
					case 'add':
						uibuilder_addcomponent(el);
						break;
					case 'components':
						SET('common.form', 'componentsform');
						break;
				}

			};
			SETTER('menu/show', opt);
		}

		function uibuilder_save() {

			var meta = CLONE(app.schema);
			var data = app.stringify();

			meta.children = data.children;
			meta.inputs = app.inputs;
			meta.outputs = app.outputs;

			if (common.iframe) {
				FUNC.send({ TYPE: 'save', data: meta });
				meta.editor.autopublish && uibuilder_publish();
				return;
			}

			if (meta.editor && meta.editor.save) {
				SETTER('approve/show', '@(Are you sure you want to save design?)', '"ti ti-check-circle" @(SAVE)', function() {
					SETTER('loading/show');
					AJAX('POST ' + meta.editor.save + ' urlencoded', { data: JSON.stringify(meta) }, ERROR(ASETTER('notify/success @hideloading', '@(Done, saved!)')));
					meta.editor.autopublish && uibuilder_publish();
				});
			} else {
				SETTER('filesaver/save', meta.name + '_editor.json', JSON.stringify(meta, null, '\t'));
				SETTER('loading/hide', 1000);
			}
		}

		function uibuilder_addcomponent(el) {
			SET('formimport @reset', { url: '' });
			SET('common.form', 'formimport');
		};

		WATCH('app.schema.editor.paths', function(path, value) {

			if (value == null)
				value = '';

			if (common.paths !== value) {
				common.paths = value;
				AJAX('GET ' + value, function(response) {

					if (response instanceof Array) {

						response = response.remove(item => !item || !item.name);

						for (var item of response) {
							if (item.type)
								item.name = item.name.encode() + (item.type ? '<span class="badge badge-small ml5 monospace" style="background:{0}">{1}</span>'.format(Thelpers.color(item.type), item.type) : '');
							else
								item.name = item.name.encode();
						}
					} else
						response = [];

					SET('DEF.cl.paths', response);
					uibuilder_rebuildpaths();
				});
			} else {
				SET('DEF.cl.paths', (common.iframepaths || []).slice(0));
				uibuilder_rebuildpaths();
			}
		});

		WATCH('app.schema.editor.codes', function(path, value) {

			if (value == null)
				value = '';

			if (common.codes !== value) {
				common.codes = value;
				AJAX('GET ' + value, function(response) {
					if (response instanceof Array)
						response = response.remove(item => !item || !item.name);
					else
						response = [];
					SET('DEF.cl.codes', response);
				});
			} else
				SET('DEF.cl.codes', (common.iframecodes || []).slice(0));

		});

		WATCH('app.schema.editor.views', function(path, value) {

			if (value == null)
				value = '';

			if (common.views !== value) {
				common.views = value;
				AJAX('GET ' + value, function(response) {
					if (response instanceof Array)
						response = response.remove(item => !item || !item.name);
					else
						response = [];
					SET('DEF.cl.views', response);
					uibuilder_rebuildpaths();
				});
			} else {
				SET('DEF.cl.views', (common.iframeviews || []).slice(0));
				uibuilder_rebuildpaths();
			}

		});

		WATCH('app.schema.editor.apps', function(path, value) {

			if (value == null)
				value = '';

			if (common.apps !== value) {
				common.apps = value;
				AJAX('GET ' + value, function(response) {

					if (response instanceof Array)
						response = response.remove(item => !item || !item.name);
					else
						response = [];

					if (common.iframeapps.slice(0))
						response.push.apply(response, common.iframeapps);

					SET('DEF.cl.apps', response);

					for (var item of app.instances)
						item.events.refresh && item.emit('refresh', { type: 'apps' });

				});

			} else
				SET('DEF.cl.apps', common.iframeapps.slice(0));

		});

		UIBuilder.on('io', function(app) {

			for (var m of app.inputs)
				m.text = m.name;

			for (var m of app.outputs)
				m.text = m.name;

			SET('DEF.cl.inputs', app.inputs);
			SET('DEF.cl.outputs', app.outputs);
			SET('DEF.cl.list', app.list);
			uibuilder_rebuildpaths();
		});

		UIBuilder.on('attr', function(el, callback) {
			el = $(el);
			var model = {};
			model.element = el;
			model.title = el.attr('title') || '';
			model.isimage = el[0].tagName === 'IMG';
			model.isiframe = el[0].tagName === 'IFRAME';
			model.id = el.attr('id') || '';
			model.width = el.attr('width') || '';
			model.height = el.attr('height') || '';
			model.src = el.attr('src') || '';
			model.css = el.attr('style') || '';
			model.cls = el.attr('class') || '';
			model.callback = () => callback(model.element);
			SET('formattr', model);
			SET('common.form2', 'formattr');
		});

		UIBuilder.on('icon', function(el, callback) {
			var opt = {};
			opt.element = $(el);
			opt.empty = true;
			opt.callback = function(val) {
				opt.element.rclass2('ti').aclass(val);
				callback(opt.element, val);
			};
			SETTER('icons/show', opt);
		});

		UIBuilder.on('link', function(el, callback) {
			el = $(el);
			var model = {};
			model.element = el;
			model.href = el.attr('href');
			model.target = el.attr('_target') || '';
			model.callback = () => callback(model.element);
			SET('formlink', model);
			SET('common.form2', 'formlink');
		});

		UIBuilder.on('make', function(instance) {

			if (!instance.protected) {

				if (!instance.component.floating)
					instance.element.attr('draggable', true);

				instance.element.on('contextmenu', function(e) {

					e.preventDefault();
					e.stopPropagation();

					var opt = {};
					opt.x = e.pageX;
					opt.y = e.pageY;
					opt.items = [];
					opt.items.push(instance.component.name);

					if (instance.component.readme)
						opt.items.push({ id: 'readme', name: '@(Read information)', icon: 'ti ti-info-circle blue' });

					opt.items.push({ id: 'settings', name: '@(Settings)', classname: 'b', icon: 'ti ti-cog' });

					if (!instance.component.floating)
						opt.items.push({ id: 'gap', name: '@(Toggle gap)', selected: instance.element.hclass('UI_gap'), icon: 'ti ti-caret-square-down' });

					if (instance.component.floating) {
						opt.items.push('-');
						opt.items.push({ id: 'bringfront', name: '@(Bring to front)', icon: 'ti ti-plus-circle green' });
						opt.items.push({ id: 'bringback', name: '@(Bring to back)', icon: 'ti ti-minus-circle green' });
					}

					if (!instance.protected) {
						opt.items.push('-');
						opt.items.push({ id: 'up', name: '@(Move up)', icon: 'ti ti-arrow-up' });
						opt.items.push({ id: 'down', name: '@(Move down)', icon: 'ti ti-arrow-down' });
						opt.items.push({ id: 'clone', name: '@(Clone)', icon: 'ti ti-clone' });
					}

					opt.items.push('-');
					opt.items.push({ id: 'remove', name: '@(Remove)', icon: 'ti ti-remove red' });
					opt.callback = function(sel) {

						var tmp;

						switch (sel.id) {
							case 'up':
							case 'down':
								component_move(instance, sel.id === 'up');
								break;
							case 'clone':
								component_clone(instance);
								break;
							case 'bringfront':
								tmp = +instance.element.css('z-index');
								instance.element.css('z-index', tmp + 1);
								break;
							case 'bringback':
								tmp = +instance.element.css('z-index');
								if (tmp > 1)
									instance.element.css('z-index', tmp - 1);
								break;
							case 'readme':
								var com = instance.component;
								FUNC.readme(com.name, com.readme || '@(Without readme)');
								break;
							case 'gap':
								instance.element.tclass('UI_gap');
								break;
							case 'settings':
								opensettings(instance.element);
								break;
							case 'remove':
								instance.remove();
								break;
						}

					};

					SETTER('menu/show', opt);
				});
			}

		});

		function uibuilder_close() {
			FUNC.send({ TYPE: 'close' });
		}

		SETTER(true, 'shortcuts/register', 'F5', function(e) {
			uibuilder_redraw();
		}, true);

		SETTER(true, 'shortcuts/register', 'save', function(e) {
			uibuilder_save();
		}, true);

	</script>

</body>
</html>