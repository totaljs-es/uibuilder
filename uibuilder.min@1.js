!function(p){function c(){}function m(){var e=this;e.state={init:0,value:null,disabled:!1,modified:!1,readonly:!1,touched:!1,invalid:!1,delay:10,notify:!1,bind:!1},e.cache={},e.events={},e.$inputs={},e.$outputs={}}c.prototype.stopPropagation=function(){this.$propagation=!0};var e=m.prototype;function r(f,e,u,t){var n=this,i=n.objects[e.object];if(i){var o=document.createElement('DIV'),r=new m;if(e.gap&&o.classList.add('UI_gap'),e.bind&&(r.state.bind=!0),e.notify&&(r.state.notify=!0),i.config||(i.config={}),r.id=e.id,r.args=n.args,r.element=$(o),r.element.aclass(p.selectors.object.substring(1)+' '+i.cls).attrd('id',e.id),r.dom=o,r.events={},r.config=CLONE(i.config),r.app=n,r.object=i,r.protected=e.protected,r.meta=e,r.edit=v,e.config)for(var s in e.config)r.config[s]=e.config[s];r.config.name||(r.config.name=i.name),n.instances.push(r);var a,c=f.closest(p.selectors.object);if(c&&c.length&&(r.parent=c[0].uibuilder,r.parent&&((a=r.parent).children||(a.children=[]),a.containers||(a.containers={}),s='container'+u,a.children.push(r),a.containers[s]?null==t?a.containers[s].push(r):a.containers[s].splice(t,0,r):a.containers[s]=[r])),o.uibuilder=r,c=$(f),null==t)c.append(o);else{for(var d=!1,l=0;l<c[0].children.length;l++)if(l===t){c[0].insertBefore(o,c[0].children[l]),d=!0;break}d||c.append(o)}i.make(r,r.config,r.element),p.events.make&&p.emit('make',r),e.children instanceof Array?setTimeout(function(e,t){for(var n=h(e,t.id),i=0;i<t.children.length;i++){var o,r=n.findItem('index',i);if(r)for(o of t.children[i])e.compile(r.element,o,i)}e.refreshio()},1,n,e):n.refreshio()}else console.error('Object "{0}" not found in the object list'.format(e.object))}function s(){for(var e=0;;){var t=this.instances[e];if(!t)break;!function(e){if(e){if('BODY'===e.tagName)return 1;for(var t=e.parentNode;t;){if('BODY'===t.tagName)return 1;t=t.parentNode}}}(t.dom)?(t.events.destroy&&t.emit('destroy'),this.instances.splice(e,1)):e++}this.refreshio()}e.$forcecheck=function(e){e.$checktimeout=null,e.set('invalid',!e.state.disabled&&!e.state.readonly&&(!e.validate||!e.validate()))},e.check=function(){var e=this;return e.$checktimeout&&clearTimeout(e.$checktimeout),e.$checktimeout=setTimeout(e.$forcecheck,150,e),e},e.error=function(e){var t=this.config;console.error(this.object.name+': '+t.name+(t.path?' ({0})'.format(t.path):''),e)},e.set=function(e,t,n,i){var o,r=this,s=!1;switch(e){case'disabled':case'modified':case'readonly':case'touched':case'invalid':s=!0,t=!!t}if('touched'===e&&r.check(),r.state[e]===t)return!1;if(r.state[e]=t,r.events.set&&r.emit('set',e,t,n),'value'===e){if(r.events.value&&r.emit('value',t,n),r.binded)for(var a of r.binded)a!==i&&(a.state.notify?a.emit('notify',t,i):a.set('value',t,i?'noemitstate':'',i));r.binder&&!r.state.notify&&r.binder!==i&&r.binder.set('value',t,i?'noemitstate':'',r),r.check()}if('noemitstate'!==n)return o=r.cache.e,s&&r.element.tclass('UI_'+e,t),o?r.cache.e.changes[e]=1:((o=r.cache.e=new c).id=r.id,o.instance=r,o.state=r.state,o.element=r.element,o.changes={},o.changes[e]=1,o.kind=n,setTimeout(e=>e.app.emitstate(e.cache.e),r.state.delay,r)),!0},e.input=function(e,t){return this.$inputs[e]=t,this},e.output=function(e,t){var i=this,o=(i.object.outputs||EMPTYARRAY).findItem('id',e);if(o)return t?i.$outputs[e]=t:(t=i.$outputs[e])&&t(function(e,t){var n={};n.id=i.id+'_'+o.id,n.ref=o.id,n.icon=o.icon,n.color=o.color,n.note=o.note,n.name=o.name,n.object=i.object,n.app=i.app,n.instance=i,n.err=e,n.data=t,i.app.emit('output',n),p.emit('output',n)}),i;console.error('Output "{0}" not found in the "{1}" object'.format(e,i.object.name))},e.family=function(){function n(e){if(e.children)for(var t of e.children)i.push(t),n(t)}var i=[];return n(this),i},e.remove=function(){this.element.remove(),this.app.clean()},e.clfind=function(e,t,n){return'function'==typeof t&&(n=t,t=''),this.app.clfind(e,t,n),this},e.clread=function(e,t,n){return this.app.clread(e,t,n),this},e.find=function(e){return this.app.instances.findItem('id',e)},e.hidden=function(){return HIDDEN(this.dom)},e.reset=function(){return this.events.reset&&this.emit('reset'),this},e.reconfigure=function(e){var t=this;if(t.events.configure)for(var n in e){var i=t.config[n],o=e[n];o!==i&&(t.config[n]=o,t.emit('configure',n,o))}return t},e.get=function(e){return this.state[e||'value']},e.on=function(e,t){this.events[e]?this.events[e].push(t):this.events[e]=[t]},e.off=function(e,t){var n=this.events[e];return n&&(t?-1!==(t=n.indexOf(t))&&(n.splice(t,1),n.length||delete this.events[e]):delete this.events[e]),this},e.emit=function(e,t,n,i,o,r){e=this.events[e];if(e)for(var s of e)s.call(this,t,n,i,o,r)},e.bindable=function(e){var t=!this.config.path||'@'!==this.config.path.charAt(0);return e?t&&this.config.path===e:t},e.write=function(e,t,n){if(!t||'@'===t.charAt(0))return n;var o=t.split('.');for(i=0;i<o.length-1;i++){var r=e[o[i]];e=r=null==r?e[o[i]]={}:r}return e[o[i]]=n,e},e.watch=function(e,t,n){'function'==typeof t&&(n=t,t='value');e=this.app.instance.findItem('id',e);return e&&e.on(t,n),this},e.read=function(e,t){if(!t||'@'===t.charAt(0))return e;var n=t.split('.');for(i=0;i<n.length;i++)if(!(e=e[n[i]]))return;return e},e.replace=function(e,i){var o=this;return e.replace(/\{[a-z0-9_-]+\}/gi,function(e){var t=e.substring(1,e.length-1).trim(),n=o.args[t];return null==(n=null==n&&i?i[t]:n)?e:n})},e.settings=function(){this.app.emit('settings',this),p.emit('settings',this)},p.version=1,p.selectors={object:'.UI_object',objects:'.UI_objects'},p.current='default',p.events={},p.apps={},p.on=function(e,t){this.events[e]?this.events[e].push(t):this.events[e]=[t]},p.emit=function(e,t,n,i,o,r){e=this.events[e];if(e)for(var s of e)s.call(this,t,n,i,o,r)},p.register=function(e,t){p.apps[p.current].pending.push({name:e,fn:t})};function h(e,t){var n,i=[];for(n of e.element.find(p.selectors.object+'[data-id="{0}"] {1}'.format(t,p.selectors.objects)))(n=$(n)).closest(p.selectors.object).attrd('id')===t&&i.push({index:+n.attrd('index'),element:n});return i.quicksort('index'),i}function d(e,t,n,i,o){if('string'==typeof n){var r=this.objects[n];if(!r)return void console.error('Object "{0}" not found'.format(n));n={id:'oid'+Date.now().toString(36),object:n,children:[],config:r.config||{},gap:r.gap}}if(o)for(var s in o)n.config[s]=o[s];r=h(this,e);if(r.length)for(var a of r)a.index==t&&this.compile(a.element,n,t,i);return this.refreshio(),n}p.build=function(e,a,t,i){if('function'==typeof t&&(i=t,t={}),p.apps[a.id])return p.remove(a.id),void setTimeout(p.build,100,e,a,i);p.current=a.id;function n(){if(u=null,p.editor){f.inputs=[],f.outputs=[],f.list=[];for(var e of f.instances)if(e.dom.parentNode){var t=e.object.inputs,n=e.config.name||e.object.name;if(f.list&&f.list.push({id:e.id,name:n,icon:e.object.icon,color:e.object.color}),t)for(var i of t)f.inputs.push({id:e.id+'_'+i.id,ref:i.id,name:n+': '+i.name,object:n,input:i.name,icon:e.object.icon,color:e.object.color,note:i.note,schema:i.schema});if((t=e.object.outputs)&&t.length)for(var i of t)f.outputs.push({id:e.id+'_'+i.id,ref:i.id,name:n+': '+i.name,object:n,output:i.name,icon:e.object.icon,color:e.object.color,note:i.note,schema:i.schema})}}else f.outputs=f.inputs=f.schema=null;if(!f.ready){f.ready=!0,f.callback&&f.callback(f),l.rclass('invisible');var o,r={},s={},a=!1;for(c of f.instances)!c.config.path||'@'!==c.config.path.charAt(0)||(o=c.config.path.substring(1))!=c.id&&(r[o]?r[o].push(c):r[o]=[c],s[c.id]=o,a=!0);if(a)for(var c of f.instances)c.binded=r[c.id]||null,c.binder=s[c.id]?f.instances.findItem('id',s[c.id]):null;for(c of f.instances)c.state.init=1,c.events.ready&&c.emit('ready');p.emit('app',f)}f.emit('io',f),p.emit('io',f)}var l=$('<div>'),f=(l.attrd('id',a.id),l.aclass('UI_app invisible'),l.empty(),$(e).append(l),{}),o=[],u=(f.id=p.current,f.objects={},f.args=t,f.schema=a,f.events={},f.compile=r,f.stringify=g,f.clean=s,f.add=d,f.remove=()=>p.remove(f.id),f.class='ui_'+HASH(p.current).toString(36),f.element=l,f.dom=l[0],f.pending=[],f.instances=[],p.clfind?f.clfind=p.clfind:f.clfind=function(e,t,n){n(EMPTYARRAY)},p.clread?f.clread=p.clread:f.clread=function(e,t,n){n(EMPTYOBJECT)},f.on=function(e,t){this.events[e]?this.events[e].push(t):this.events[e]=[t]},f.emit=function(e,t,n,i,o,r){e=this.events[e];if(e)for(var s of e)s.call(this,t,n,i,o,r)},f.intervalcounter=0,f.interval&&clearInterval(f.interval),f.interval=setInterval(function(e){if(W.inDOM(e.dom)){e.intervalcounter++;for(var t of e.instances)t.events.service&&t.emit('service',e.intervalcounter)}else e.remove()},6e4,f),f.recompile=function(){f.clean();for(var e,t=0;t<f.schema.children.length;t++)for(e of f.schema.children[t])e.protected=!0,f.compile(f.element,e,t)},null);f.refreshio=function(e){e?n():(u&&clearTimeout(u),u=setTimeout(n,100))},f.input=function(e,t,n){n=n||NOOP;var i=e.indexOf('_'),o=e.substring(0,i),e=e.substring(i+1),i=f.instances.findItem('id',o);i?(i=i.$inputs[e])?i(t,n):n('Input "{0}" not found'.format(e)):n('Instance "{0}" not found'.format(o))},f.output=function(e){i=i||NOOP;var t=e.indexOf('_'),n=e.substring(0,t),e=e.substring(t+1),t=f.instances.findItem('id',n);t?t.output(e):i('Instance "{0}" not found'.format(n))},f.emitstate=function(e){var t,n={},i='state',o=e.instance,r=(e.instance.cache.e=null,o.parent);for(e.level=0;r&&(e.level++,n[r.id]=!0,r.events[i]&&r.emit(i,e),!e.$propagation);)r=r.parent;e.level=null,i='@state';for(t of f.instances)n[o.id]||t===e.instance||t.events[i]&&t.emit(i,e)},p.parsehtml=function(e){var t='';if(-1===e.indexOf('<script>'))return{js:e};var n,i='',o='',t='',r='',s=e.indexOf('<settings>');return-1!==s&&(n=e.indexOf('</settings>',s+10),i=e.substring(s+8,n).trim(),e=e.substring(0,s)+e.substring(n+11)),-1!==(s=e.indexOf('<style>'))&&(t=e.substring(s+7,e.indexOf('</style>',s+7))),-1!==(s=e.indexOf('<readme>'))&&(o=e.substring(s+8,e.indexOf('</readme>',s+8))),-1!==(s=e.indexOf('<script>'))&&(n=e.indexOf('<\/script>',s+8),r=e.substring(s+8,n).trim()),{js:r,css:t,settings:i,readme:o}},p.apps[p.current]=f,Object.keys(a.objects).wait(function(n,i){var e=a.objects[n];if('string'==typeof e){var o=((t=e.split(' '))[1]||'').trim(),t=t[0].trim();if(o||(o=t,t=''),'base64'!==(t=t&&'.html'===t.charAt(0)?t.substring(1):t))t&&'html'!==t||AJAX('GET '+o,function(e){if(ERROR(e))return console.error('UI Builder:',o,e),i;e=p.parsehtml(e);try{var t={};t.id=n,t.cls=f.class+'_'+HASH(t.id).toString(36),e.css&&(t.css=e.css),e.readme&&(t.readme=e.readme),e.settings&&(t.settings=e.settings),new Function('exports',e.js.replace(/CLASS/g,t.cls))(t),f.pending.push({name:n,fn:t})}catch(e){console.error('UI Builder:',n,e)}i()});else{try{var r={},s=(r.id=n,r.cls=f.class+'_'+HASH(r.id).toString(36),p.parsehtml(decodeURIComponent(atob(o))));s.css&&(r.css=s.css),new Function('exports',s.js)(r),f.pending.push({name:n,fn:r})}catch(e){console.error('UI Builder:',n,e)}i()}}else f.pending.push({name:n,fn:e}),i()},function(){f.pending.splice(0).wait(function(e,t){var n=null;'function'==typeof e.fn?((n={}).id=e.name,n.cls=f.class+'_'+HASH(n.id).toString(36),e.fn(n)):n=e.fn,(f.objects[e.name]=n).css&&o.push(n.css.replace(/CLASS/g,n.cls)),n.import instanceof Array?n.import.wait(IMPORT,t):t()},function(){a.css&&o.unshift(a.css),CSS(o,f.class);for(var e,t=0;t<a.children.length;t++)for(e of a.children[t])e.protected=!0,f.compile(l,e,t);f.callback=i})})},p.remove=function(t){var n=p.apps[t];if(n){n.interval&&clearInterval(n.interval),n.interval=null;for(var e of n.instances)e.events.destroy&&e.emit('destroy');setTimeout(function(){for(var e in n.objects){e=n.objects[e];e.uninstall&&e.uninstall()}n.tmp=null,CSS('',n.class),n.element.remove(),delete p.apps[t]},2)}};var a=null,l=document;function v(n,i,e){var t,o,r;n instanceof jQuery||(n=$(n)),null==(i=i||{}).format&&(i.format=!0),e&&(i.callback=e),a?a.element[0]!=n[0]&&(a.close(),setTimeout(v,100,n,i,e)):(i.backup=n.html(),i.html&&n.html(i.html),n.attr('contenteditable',!0),n.aclass('UI_editing'),(a={}).element=n,a.dom=n[0],a.parent=i.parent?i.parent[0]:a.dom,a.createlink=function(){if(function(e){if(l.selection&&'Text'===l.selection.type)return l.selection.createRange().htmlText;if(W.getSelection){var t=W.getSelection();if(!t.rangeCount)return'';for(var n=l.createElement('div'),i=0,o=t.rangeCount;i<o;++i)n.appendChild(t.getRangeAt(i).cloneContents());return e?n:n.innerHTML}}().trim()){for(var e=a.element,t='#link'+Date.now().toString(36),n=e[0],i=0;i<5;i++){if('A'===n.tagName)return;if(!(n=n.parentNode))break}document.execCommand('CreateLink',!1,t);var o,e=e.find('a[href="'+t+'"]');e.length&&(a&&a.close(),t=e.text(),o='',e.aclass('UI_link'),-1!==t.indexOf('@')?o='mailto:'+t:/\d+/.test(t)?o='tel:'+t:-1===t.indexOf(' ')&&-1===t.indexOf(',')&&-1!==t.indexOf('.')&&(o=/http(s):\/\//.test(t)?t:'https://'+t),t=-1!==o.indexOf('.')&&-1===o.indexOf(location.hostname)?'_blank':'',e.attr('href',o||'#'),e.attr('target',t),p.emit('link',e,NOOP))}},t=function(e){e.target===a.parent||a.parent.contains(e.target)||a.close()},o=function(e){if(i.keydown&&i.keydown(e),27===e.keyCode)return e.preventDefault(),e.stopPropagation(),a.key=27,void a.close();if(i.backslashremove&&8===e.keyCode&&!n.text().trim())return a.key=8,void a.close();if(13!==e.keyCode){if(9===e.keyCode)return i.tabs?(e.preventDefault(),void document.execCommand('insertHTML',!1,'&#009')):(i.endwithtab?(e.preventDefault(),a.key=9):(e.preventDefault(),e.stopPropagation()),void a.close());if(a.change=!0,e.metaKey||e.ctrlKey)if(66!==e.keyCode)if(76!==e.keyCode)if(73!==e.keyCode){var t;if(80===e.keyCode)return i.format&&!0===i.icon&&(t='<i class="ti ti-totaljs UI_icon" contenteditable="false"></i>','span'===n[0].nodeName.toLowerCase()?n.parent().prepend(t):document.execCommand('insertHTML',!1,t)),e.preventDefault(),void e.stopPropagation();85!==e.keyCode?32===e.keyCode&&(document.execCommand('insertHTML',!1,'&nbsp;'),e.preventDefault(),e.stopPropagation()):i.format&&!1!==i.underline||(e.preventDefault(),e.stopPropagation())}else i.format&&!1!==i.italic||(e.preventDefault(),e.stopPropagation());else i.format&&!1!==i.link?a.createlink():(e.preventDefault(),e.stopPropagation());else i.format&&!1!==i.bold||(e.preventDefault(),e.stopPropagation())}else i.multiline&&!e.shiftKey||(e.preventDefault(),e.stopPropagation(),a.key=13,a.close())},n.focus(),'end'===i.cursor&&((e=document.createRange()).selectNodeContents(n[0]),e.collapse(!1),(r=W.getSelection()).removeAllRanges(),r.addRange(e)),a.close=function(){var e;$(W).off('click',t),n.rattr('contenteditable'),n.off('keydown',o),n.rclass('UI_editing'),i.callback&&((e={}).text=n.text().trim(),e.html=n.html(),e.change=a.change,e.element=a.element,e.dom=a.dom,e.backup=i.backup,e.key=a.key,e.param=i.param,i.callback(e)),a.timeout&&clearTimeout(a.timeout),a=null},$(W).on('click',t),n.on('keydown',o))}function g(e){var t,l=this,f='function'==typeof e?e:null,n=(e=f?null:e)||l.element.find('> '+p.selectors.object),i=[],u=[];for(t of n){var o={children:[]};i.push(o),function e(t,n){var i,o=n.uibuilder;if(t.id=n.getAttribute('data-id'),t.config=o.config,t.object=o.object.id,!f||f(t)){u.push(o),n.classList.contains('UI_gap')&&(t.gap=!0),o.children=[];for(i of h(l,t.id)){var r,s=[],a=i.element.find('> '+p.selectors.object);t.children||(t.children=[]),t.children.push(s);for(r of a){var c={children:[]};s.push(c),o.children.push(r.uibuilder),e(c,r)}}o.events.stringify&&o.emit('stringify',t)}}(o,t)}i=e?i[0]:[i];return{instances:u,children:i}}}(W.UIBuilder={});