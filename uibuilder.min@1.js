!function(p){function r(){}function m(){var e=this;e.state={init:0,value:null,disabled:!1,modified:!1,readonly:!1,affected:!1,delay:10},e.cache={},e.events={},e.$inputs={},e.$outputs={}}r.prototype.stopPropagation=function(){this.$propagation=!0};var e=m.prototype;function l(f,e,u,t){var n=this,i=n.objects[e.object];if(i){var o=document.createElement('DIV'),r=new m;if(e.gap&&o.classList.add('UI_gap'),i.config||(i.config={}),r.id=e.id,r.args=n.args,r.element=$(o),r.element.aclass(p.selectors.object.substring(1)+' '+i.cls).attrd('id',e.id),r.dom=o,r.events={},r.config=CLONE(i.config),r.app=n,r.object=i,r.protected=e.protected,r.meta=e,r.edit=h,e.config)for(var s in e.config)r.config[s]=e.config[s];r.config.name||(r.config.name=i.name),n.instances.push(r);var a,c=f.closest(p.selectors.object);if(c&&c.length&&(r.parent=c[0].uibuilder,r.parent&&((a=r.parent).children||(a.children=[]),a.containers||(a.containers={}),s='container'+u,a.children.push(r),a.containers[s]?null==t?a.containers[s].push(r):a.containers[s].splice(t,0,r):a.containers[s]=[r])),o.uibuilder=r,c=$(f),null==t)c.append(o);else{for(var d=!1,l=0;l<c[0].children.length;l++)if(l===t){c[0].insertBefore(o,c[0].children[l]),d=!0;break}d||c.append(o)}i.make(r,r.config,r.element),p.events.make&&p.emit('make',r),e.children instanceof Array?setTimeout(function(e,t){for(var n=0;n<t.length;n++){var i,o=r.element.find(p.selectors.objects+'[data-index="{0}"]'.format(n));if(o.length)for(i of t[n])e.compile(o,i,n)}e.refreshio()},1,n,e.children):n.refreshio()}else console.error('Object "{0}" not found in the object list'.format(e.object))}function f(){for(var e=0;;){var t=this.instances[e];if(!t)break;!function(e){if(e){if('BODY'===e.tagName)return 1;for(var t=e.parentNode;t;){if('BODY'===t.tagName)return 1;t=t.parentNode}}}(t.dom)?(t.events.destroy&&t.emit('destroy'),this.instances.splice(e,1)):e++}this.refreshio()}e.set=function(e,t,n){var i=this;switch(e){case'disabled':case'modified':case'readonly':case'affected':t=!!t}if(i.state[e]!==t){i.state[e]=t,i.events.set&&i.emit('set',e,t,n);var o=i.cache.e;if(!o)return(o=i.cache.e=new r).id=i.id,o.instance=i,o.state=i.state,o.element=i.element,o.changes={},o.changes[e]=1,o.kind=n,setTimeout(e=>e.app.emitstate(e.cache.e),i.state.delay,i),i;i.cache.e.changes[e]=1}},e.input=function(e,t){return this.$inputs[e]=t,this},e.output=function(e,t){var i=this,o=(i.object.outputs||EMPTYARRAY).findItem('id',e);if(o)return t?i.$outputs[e]=t:(t=i.$outputs[e])&&t(function(e,t){var n={};n.id=i.id+'_'+o.id,n.ref=o.id,n.icon=o.icon,n.color=o.color,n.note=o.note,n.name=o.name,n.object=o.instance.object,n.app=i.app,n.instance=i,n.err=e,n.data=t,i.app.emit('output',n),p.emit('output',n)}),i;console.error('Output "{0}" not found in the "{1}" object'.format(e,i.object.name))},e.family=function(){function n(e){if(e.children)for(var t of e.children)i.push(t),n(t)}var i=[];return n(this),i},e.remove=function(){this.element.remove(),this.app.clean()},e.cl=function(e,t,n){return'function'==typeof t&&(n=t,t=null),this.app.cl(e,t,n),this},e.find=function(e){return this.app.instances.findItem('id',e)},e.hidden=function(){return HIDDEN(this.dom)},e.reset=function(){var e=this;return e.events.reset&&e.emit('reset'),e},e.get=function(e){return this.state[e||'value']},e.on=function(e,t){var n=this;n.events[e]?n.events[e].push(t):n.events[e]=[t]},e.emit=function(e,t,n,i,o,r){e=this.events[e];if(e)for(var s of e)s.call(this,t,n,i,o,r)},e.write=function(e,t,n){var o=t.split('.');for(i=0;i<o.length-1;i++)e=e[o[i]];e[o[i]]=n},e.read=function(e,t){var n=t.split('.');for(i=0;i<n.length;i++)if(!(e=e[n[i]]))return;return e},e.replace=function(e,i){var o=this;return e.replace(/\{[a-z0-9]+\}/gi,function(e){var t=e.substring(1,e.length-1).trim(),n=o.args[t];return null==(n=null==n&&i?i[t]:n)?e:n})},e.settings=function(){this.app.emit('settings',this),p.emit('settings',this)},p.version=1,p.selectors={object:'.UI_object',objects:'.UI_objects'},p.current='default',p.events={},p.apps={},p.repo={},p.refs={},p.tmp={},p.on=function(e,t){this.events[e]?this.events[e].push(t):this.events[e]=[t]},p.emit=function(e,t,n,i,o,r){e=this.events[e];if(e)for(var s of e)s.call(this,t,n,i,o,r)},p.register=function(e,t){p.apps[p.current].pending.push({name:e,fn:t})};function d(e,t){var n,i=[];for(n of e.element.find(p.selectors.object+'[data-id="{0}"] {1}'.format(t,p.selectors.objects)))(n=$(n)).closest(p.selectors.object).attrd('id')===t&&i.push({index:+n.attrd('index'),element:n});return i.quicksort('index'),i}function u(e,t,n,i,o){if('string'==typeof n){var r=this.objects[n];if(!r)return void console.error('Object "{0}" not found'.format(n));n={id:'oid'+Date.now().toString(36),object:n,children:[],config:r.config||{}}}if(o)for(var s in o)n.config[s]=o[s];r=d(this,e);if(r.length)for(var a of r)a.index==t&&this.compile(a.element,n,t,i);return this.refreshio(),n}p.build=function(e,a,t,i){if('function'==typeof t&&(i=t,t={}),p.apps[a.id])return p.remove(a.id),void setTimeout(p.build,100,e,a,i);p.current=a.id;function n(){s=null,c.inputs=[],c.outputs=[];for(var e of c.instances)if(e.dom.parentNode){var t=e.object.inputs,n=e.config.name||e.object.name;if(t)for(var i of t)c.inputs.push({id:e.id+'_'+i.id,ref:i.id,name:n+': '+i.name,object:n,input:i.name,icon:i.icon,color:i.color,note:i.note,schema:i.schema});if((t=e.object.outputs)&&t.length)for(var i of t)c.outputs.push({id:e.id+'_'+i.id,ref:i.id,name:n+': '+i.name,object:n,output:i.name,icon:i.icon,color:i.color,note:i.note,schema:i.schema})}if(!c.ready){c.ready=!0,c.callback&&c.callback(c),r.rclass('invisible');for(var o of c.instances)o.state.init=1,o.events.ready&&o.emit('ready');p.emit('app',c)}c.emit('io',c),p.emit('io',c)}var r=$('<div>'),c=(r.attrd('id',a.id),r.aclass('UI_app invisible'),r.empty(),a.css&&(r[0].style=a.css),$(e).append(r),{}),o=[],s=(c.id=p.current,c.objects={},c.args=t,c.repo=p.repo,c.refs=p.refs,c.schema=a,c.outputs=[],c.events={},c.inputs=[],c.compile=l,c.stringify=v,c.clean=f,c.add=u,c.remove=()=>p.remove(c.id),c.class='ui_'+HASH(p.current).toString(36),c.element=r,c.dom=r[0],c.pending=[],c.instances=[],c.tmp={},c.cl=function(e,t,n){'function'==typeof t&&(n=t,t=null),n(t?null:EMPTYARRAY)},c.on=function(e,t){this.events[e]?this.events[e].push(t):this.events[e]=[t]},c.emit=function(e,t,n,i,o,r){e=this.events[e];if(e)for(var s of e)s.call(this,t,n,i,o,r)},c.intervalcounter=0,c.interval=setInterval(function(e){if(W.inDOM(e.dom)){e.intervalcounter++;for(var t of e.instances)t.events.service&&t.emit('service',e.intervalcounter)}else e.remove()},6e4,c),c.recompile=function(){c.clean();for(var e,t=0;t<c.schema.children.length;t++)for(e of c.schema.children[t])e.protected=!0,c.compile(c.element,e,t)},null);c.refreshio=function(e){e?n():(s&&clearTimeout(s),s=setTimeout(n,100))},c.input=function(e,t,n){n=n||NOOP;var i=e.indexOf('_'),o=e.substring(0,i),e=e.substring(i+1),i=c.instances.findItem('id',o);i?(i=i.$inputs[e])?i(t,n):n('Input "{0}" not found'.format(e)):n('Instance "{0}" not found'.format(o))},c.output=function(e){i=i||NOOP;var t=e.indexOf('_'),n=e.substring(0,t),e=e.substring(t+1),t=c.instances.findItem('id',n);t?t.output(e):i('Instance "{0}" not found'.format(n))},c.emitstate=function(e){var t,n={},i='state',o=e.instance,r=(e.instance.cache.e=null,o.parent);for(e.level=0;r&&(e.level++,n[r.id]=!0,r.events[i]&&r.emit(i,e),!e.$propagation);)r=r.parent;e.level=null,i='@state';for(t of c.instances)n[o.id]||t===e.instance||t.events[i]&&t.emit(i,e)},p.parsehtml=function(e){var t='';if(-1===e.indexOf('<script>'))return{js:e};var n,i='',o='',t='',r=e.indexOf('<settings>');return-1!==r&&(n=e.indexOf('</settings>',r+10),i=e.substring(r+8,n).trim(),e=e.substring(0,r)+e.substring(n+11)),-1!==(r=e.indexOf('<style>'))&&(t=e.substring(r+7,e.indexOf('</style>',r+7))),-1!==(r=e.indexOf('<script>'))&&(n=e.indexOf('<\/script>',r+8),o=e.substring(r+8,n).trim()),{js:o,css:t,settings:i}},p.apps[p.current]=c,Object.keys(a.objects).wait(function(n,i){var e=a.objects[n];if('string'==typeof e){var t=((o=e.split(' '))[1]||'').trim(),o=o[0].trim();if(t||(t=o,o=''),'base64'!==(o=o&&'.html'===o.charAt(0)?o.substring(1):o))o&&'html'!==o||AJAX('GET '+t,function(e){e=p.parsehtml(e);try{var t={};t.id=n,t.cls=c.class+'_'+HASH(t.id).toString(36),e.css&&(t.css=e.css),e.settings&&(t.settings=e.settings),new Function('exports',e.js)(t),c.pending.push({name:n,fn:t})}catch(e){console.error('UI Builder:',n,e)}i()});else{try{var r={},s=(r.id=n,r.cls=c.class+'_'+HASH(r.id).toString(36),p.parsehtml(decodeURIComponent(atob(t))));s.css&&(r.css=s.css),new Function('exports',s.js)(r),c.pending.push({name:n,fn:r})}catch(e){console.error('UI Builder:',n,e)}i()}}else c.pending.push({name:n,fn:e}),i()},function(){c.pending.splice(0).wait(function(e,t){var n=null;'function'==typeof e.fn?((n={}).id=e.name,n.cls=c.class+'_'+HASH(n.id).toString(36),e.fn(n)):n=e.fn,(c.objects[e.name]=n).css&&o.push(n.css.replace(/CLASS/g,n.cls)),n.import instanceof Array?n.import.wait(IMPORT,t):t()},function(){CSS(o,c.class);for(var e,t=0;t<a.children.length;t++)for(e of a.children[t])e.protected=!0,c.compile(r,e,t);c.callback=i})})},p.remove=function(t){var n=p.apps[t];if(n){n.interval&&clearInterval(n.interval),n.interval=null;for(var e of n.instances)e.events.destroy&&e.emit('destroy');setTimeout(function(){for(var e in n.objects){e=n.objects[e];e.uninstall&&e.uninstall()}n.tmp=null,CSS('',n.class),n.element.remove(),delete p.apps[t]},2)}};var s=null;function h(t,n,e){var i,o,r;t instanceof jQuery||(t=$(t)),null==(n=n||{}).format&&(n.format=!0),e&&(n.callback=e),s?s.element[0]!=t[0]&&(s.close(),setTimeout(h,100,t,n,e)):(n.backup=t.html(),n.html&&t.html(n.html),t.attr('contenteditable',!0),t.aclass('UI_editing'),(s={}).element=t,s.dom=t[0],s.parent=n.parent?n.parent[0]:s.dom,i=function(e){e.target===s.parent||s.parent.contains(e.target)||s.close()},o=function(e){if(n.keydown&&n.keydown(e),27===e.keyCode)return e.preventDefault(),e.stopPropagation(),s.key=27,void s.close();if(n.backslashremove&&8===e.keyCode&&!t.text().trim())return s.key=8,void s.close();if(13!==e.keyCode){if(9!==e.keyCode&&(s.change=!0,e.metaKey||e.ctrlKey))return 66===e.keyCode?(!n.format||null!=n.bold&&1!=n.bold||self.format.bold(),e.preventDefault(),void e.stopPropagation()):76===e.keyCode?(!n.format||null!=n.link&&1!=n.link||self.format.link(),e.preventDefault(),void e.stopPropagation()):73===e.keyCode?(!n.format||null!=n.italic&&1!=n.italic||self.format.italic(),e.preventDefault(),void e.stopPropagation()):80===e.keyCode?(self.format.icon(),e.preventDefault(),void e.stopPropagation()):85===e.keyCode?(!n.format||null!=n.underline&&1!=n.underline||self.format.underline(),e.preventDefault(),void e.stopPropagation()):void(32===e.keyCode&&(document.execCommand('insertHTML',!1,'&nbsp;'),e.preventDefault(),e.stopPropagation()))}else n.multiline&&!e.shiftKey||(e.preventDefault(),e.stopPropagation(),s.key=13,s.close())},t.focus(),'end'===n.cursor&&((e=document.createRange()).selectNodeContents(t[0]),e.collapse(!1),(r=W.getSelection()).removeAllRanges(),r.addRange(e)),s.close=function(){var e;$(W).off('click',i),t.rattr('contenteditable'),t.off('keydown',o),t.rclass('UI_editing'),n.callback&&((e={}).text=t.text().trim(),e.html=t.html(),e.change=s.change,e.element=s.element,e.dom=s.dom,e.backup=n.backup,e.key=s.key,e.param=n.param,n.callback(e)),s.timeout&&clearTimeout(s.timeout),s=null},$(W).on('click',i),t.on('keydown',o))}function v(e){var t,l=this,f=e,n=(e=f?null:e)||l.element.find('> '+p.selectors.object),i=[],u=[];for(t of n){var o={children:[]};i.push(o),function e(t,n){var i,o=n.uibuilder;if(t.id=n.getAttribute('data-id'),t.config=o.config,t.object=o.object.id,!f||f(t)){u.push(o),n.classList.contains('UI_gap')&&(t.gap=!0),o.children=[];for(i of d(l,t.id)){var r,s=[],a=i.element.find('> '+p.selectors.object);t.children||(t.children=[]),t.children.push(s);for(r of a){var c={children:[]};s.push(c),o.children.push(r.uibuilder),e(c,r)}}o.events.stringify&&o.emit('stringify',t)}}(o,t)}i=e?i[0]:[i];return{instances:u,children:i}}}(W.UIBuilder={});