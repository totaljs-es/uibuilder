!function(g){var v=/CLASS/g,b='UIBuilder:';function u(e){var t=this;t.id=e.id,t.query=e.query,t.app=e,t.cache=e.cache,t.class=e.class,t.components=e.components,t.instances=[],t.events={},t.refs={}}function y(e){var t,n='';return n='/'!==e.charAt(0)?-1===(t=e.indexOf('/',9))?e:e.substring(0,t):n}function f(e){var t,n={},i={},o=!1;e.$rebindtimeout=null;for(r of e.instances)r.config.path&&'@'===r.config.path.charAt(0)&&(t=r.config.path.substring(1))!=r.id&&(n[t]?n[t].push(r):n[t]=[r],i[r.id]=t,o=!0);if(o)for(var r of e.instances)r.binded=n[r.id]||null,r.binder=i[r.id]?e.instances.findItem('id',i[r.id]):null}function p(){}function m(){var e=this;e.state={init:0,value:null,disabled:!1,modified:!1,readonly:!1,touched:!1,invalid:!1,delay:10,notify:!1,bind:!1,validate:!0},e.cache={},e.events={},e.$inputs={},e.$outputs={},e.iseditor=g.editor}u.prototype.find=function(e){var t,n='.'===e.charAt(0)?e.substring(1):'',e=n?'':'@'===e.charAt(0)?e.substring(1):e;for(t of this.instances)if(n){if(t.config.path===n)return t}else if(t.id===e)return t},u.prototype.urlify=function(){return this.app.urlify.apply(this.app,arguments),this},u.prototype.clfind=function(){return this.app.clfind.apply(this.app,arguments),this},u.prototype.clread=function(){return this.app.clread.apply(this.app,arguments),this},u.prototype.view=function(){return this.app.view.apply(this.app,arguments),this},u.prototype.clean=function(){return this},u.prototype.on=function(e,t){var n=this;n.events[e]?n.events[e].push(t):n.events[e]=[t]},u.prototype.rebind=function(){var e=this;e.$rebindtimeout&&clearTimeout(e.$rebindtimeout),e.$rebindtimeout=setTimeout(f,50,e)},u.prototype.emit=function(e,t,n,i,o,r){e=this.events[e];if(e)for(var s of e)s.call(this,t,n,i,o,r)},u.prototype.emitstate=function(e,t){var n,i={},o=e.instance,r=t=t||'state',s='noemit'+t,a=(e.instance.cache[r]=null,o.parent),c=0;for(e.level=0,e.type=t;a&&(e.level++,i[a.id]=!0,!a.fork)&&(a.events[t]&&(c++,a.emit(t,e)),!e.$propagation);)a=a.parent;e.level=null,t='@'+t;for(n of this.instances)i[o.id]||n===e.instance||n.events[t]&&(c++,n.emit(t,e));o.state[s]=0===c},customElements.define('uibuilder-app',class extends HTMLElement{constructor(){super(),setTimeout(()=>this.compile(),1)}compile(){var h={},n=this,g=0,v=(h.id=n.getAttribute('uid')||'',h.id||(h.id=Date.now().toString(36)+GUID(5)),h.name=n.getAttribute('name')||'',h.css=n.getAttribute('css')||void 0,h.version=n.getAttribute('version')||'1',h.icon=n.getAttribute('icon')||void 0,h.args=(n.getAttribute('args')||'').parseConfig(),h.children=[],h.components={},function(e,t,n){var i,o,r,s=[],a=[];for(i of t.children)switch(i.tagName){case'UIBUILDER-CONTAINER':s.push(i);break;case'UIBUILDER-BRICK':var c=i.$uibuilderbrick={};if(c.id=i.getAttribute('uid')||'instance'+g++,c.component=i.getAttribute('name')||i.getAttribute('component'),c.component){c.config=(i.getAttribute('config')||'').parseConfig(),c.x=i.getAttribute('x')||'',c.x=c.x?c.x.parseInt():void 0,c.y=i.getAttribute('y')||'',c.y=c.y?c.y.parseInt():void 0,c.zindex=i.getAttribute('zindex')||'',c.zindex=c.zindex?c.zindex.parseInt():void 0,c.children=[],c.iscontainer='UIBUILDER-CONTAINER'===i.parentNode.tagName;for(var l of i.children)if('SCRIPT'===l.tagName){var f=PARSE(l.innerHTML);if(f)for(var u in f)c.config[u]=f[u]}var p=i.getAttribute('path');p&&(c.config.path=p),a.push(i),h.components[c.component];h.components[c.component]||(h.components[c.component]=i.getAttribute('source')||'@')}else W.console&&W.console.warn(b,'Invalid brick declaration.',i)}n&&!s.length&&(e.push(t=[]),e=t);for(o of a){var d=o.$uibuilderbrick;if(e.push(d),o.children.length){let e=d.children;d.iscontainer||(e=[],d.children.push(e)),v(e,o)}}for(r of s){var m=[];e.push(m),v(m,r)}});v(h.children,n,!0),UIBuilder.build(n,h,function(e){var t=n.getAttribute('load');(t=t&&GET(t))&&'function'==typeof t&&t(e)})}}),customElements.define('uibuilder-brick',class extends HTMLElement{constructor(){super()}}),customElements.define('uibuilder-container',class extends HTMLElement{constructor(){super()}}),customElements.define('uibuilder-component',class extends HTMLElement{constructor(){super(),setTimeout(()=>this.compile(),1)}compile(){var e,t=this,n=t.parentNode,i=g.selectors.component.substring(1);for(t.classList.add('block');n;){if('BODY'===n.tagName)return;if(n.classList.contains(i)){e=n.uibuilder;break}n=n.parentNode}var o,r=!0,s=(e.fork||(r=!1,e.fork=new u(e.app),e.fork.element=e.element,e.fork.compile=h,e.root=e),(t.getAttribute('config')||'').parseConfig()),a={},c=(a.id=t.getAttribute('uid')||'ui'+GUID(10),a.config=s||{},a.component=t.getAttribute('name'),!1);for(o in s)if('#'===s[o]){var l=t.children[0];if(l&&'SCRIPT'===l.tagName)switch(l.getAttribute('type')){case'application/json':case'text/json':s[o]=PARSE(l.innerHTML.trim());break;case'text/html':case'text/plain':s[o]=l.innerHTML.trim()}else s[o]=t.innerHTML;c=!0}c&&(t.innerHTML='');var f=t.getAttribute('path'),f=(f&&(s.path=f),e.fork.components[a.component]);f?(t.innerHTML&&(s.name=t.innerHTML.trim(),t.innerHTML=''),s.name||(s.name=f.name),(s.$bind||t.getAttribute('bind'))&&(a.bind=!0),(s.$notify||t.getAttribute('notify'))&&(a.notify=!0),a.readonly=!0,e.fork.compile(t,a,null,null,t),t.uibuilder&&(t.uibuilder.parent=e),e.fork.rebind(),(f=t.classList).remove('invisible'),f.remove('hidden'),r||setTimeout(e=>e.emit('fork',e.fork),1,e)):(console.error(b,'The component not found: '+a.component),t.parentNode.removeChild(t))}}),p.prototype.stopPropagation=function(){this.$propagation=!0};function i(){return''}var r,e=m.prototype;e.$forcecheck=function(e){e.$checktimeout=null;var t=!1;e.state.disabled||e.state.readonly?t=!1:e.validate&&(!0===(t=e.validate())||1===t||''===t||t instanceof Array&&!t.length?t=!1:!1!==t&&0!==t||(t=!0)),e.set('invalid',t)},e.$forcechange=function(e){e.$changetimeout=null,e.app.emit('change',e)},e.errors=function(){var e,t=[],n=this.state.invalid,i=typeof n;if(n&&'boolean'!=i&&'number'!=i)if('string'==i)t.push({error:n});else if(n instanceof Array)for(var o of n)o&&('string'==typeof o?t.push({error:o}):(e=o.error||o.err||o.msg||o.message)&&t.push({error:e}));else(e=n.error||n.err||n.msg||n.message)&&t.push({error:e});return t},e.change=function(){var e=this;e.app.events.change&&(e.$changetimeout&&clearTimeout(e.$changetimeout),e.$changetimeout=setTimeout(e.$forcechange,50,e))},e.check=function(e){var t=this;if(!1!==t.state.validate)return t.$checktimeout&&clearTimeout(t.$checktimeout),e?t.$forcecheck(t):t.$checktimeout=setTimeout(t.$forcecheck,50,t),t};function o(e,t,n,i){var o={};o.id=e.id+'_'+t.id,o.instanceid=e.id,o.componentid=e.component.id,o.ref=t.id,o.icon=t.icon,o.color=t.color,o.note=t.note,o.name=t.name,o.component=e.component,o.app=e.app,o.instance=e,o.err=n,o.data=i,e.app.emit('output',o),g.emit('output',o)}function s(){r=null;var e,t=[];for(e in g.components){var n=g.components[e];n.css&&t.push(n.css)}CSS(t,'uibuilder')}function h(e,t,n,i,o,r){var s=this,a=s.components[t.component];if(a){var c=o||document.createElement('DIV'),f=new m;if(c.classList.add('ui_'+a.id),t.gap&&c.classList.add('UI_gap'),a.floating&&(c.classList.add('UI_floating'),c.style='left:{0}px;top:{1}px;z-index:{2};position:absolute'.format(t.x||0,t.y||0,t.zindex||1)),t.bind&&(f.state.bind=!0),t.notify&&(f.state.notify=!0),a.config||(a.config={}),f.id=t.id,f.args=s.args,f.newbie=r||t.newbie,f.element=$(c),f.element.aclass(g.selectors.component.substring(1)+' '+a.cls).attrd('id',t.id),f.dom=c,f.events={},f.config=CLONE(a.config),f.app=s,f.component=a,f.protected=t.protected,f.meta=t,f.edit=I,t.newbie&&delete t.newbie,o&&(f.forked=!0),t.config)for(var l in t.config)f.config[l]=t.config[l];if(f.config.name||(f.config.name=a.name),s.instances.push(f),o&&(r=e.getAttribute('uid'))&&(s.refs[r]=f),c.uibuilder=f,!o){var u=e.closest(g.selectors.component);if(u&&u.length&&(f.parent=u[0].uibuilder,f.parent)&&((r=f.parent).children||(r.children=[]),r.containers||(r.containers={}),l='container'+n,r.children.push(f),r.containers[l]?null==i?r.containers[l].push(f):r.containers[l].splice(i,0,f):r.containers[l]=[f]),u=$(e),null==i)u.append(c);else{for(var p=!1,d=0;d<u[0].children.length;d++)if(d===i){u[0].insertBefore(c,u[0].children[d]),p=!0;break}p||u.append(c)}}a.make&&a.make(f,f.config,f.element,f.component.cls,g.editor),g.events.make&&g.emit('make',f),o||(t.children instanceof Array?setTimeout(function(e,t){for(var n=k(e,t.id),i=0;i<t.children.length;i++){var o=n.findItem('index',i);if(o)for(l of t.children[i])e.compile(o.element,l,i)}var r=e.components[t.component];if(r.children)for(var s={},a=CLONE(r.children),c=function(e){for(var t of e)for(var n of t)s[n.id]=f.id+'X'+HASH(n.id).toString(36),n.children&&n.children.length&&c(n.children)},r=(c(a),Object.keys(s)),r=new RegExp(r.join('|'),'g'),a=PARSE(JSON.stringify(a).replace(r,e=>s[e])),i=0;i<a.length;i++){var l,o=n.findItem('index',i);if(o)for(l of a[i])e.compile(o.element,l,i)}e.refreshio()},1,s,t):s.refreshio())}else console.error(b,'The component "{0}" not found'.format(t.component))}function A(){for(var e=0,t=0,n=[];;){var i=this.instances[e];if(!i)break;if(function(e){if(e){if('BODY'===e.tagName)return 1;for(var t=e.parentNode;t;){if('BODY'===t.tagName)return 1;t=t.parentNode}}}(i.dom))e++;else{if(t++,i.removecss)for(var o of i.removecss)CSS('',o);i.events.destroy&&i.emit('destroy'),this.instances.splice(e,1),n.push(i)}}if(this.refreshio(),t)for(var r of this.instances)r.events.refresh&&r.emit('refresh',{type:'remove',items:n})}e.maketemplate=function(e){var t,n=this;return(e=e||n.component.html)?(t=HASH(e).toString(36),n.app.cache[t]||(n.app.cache[t]=-1===e.indexOf('{{')?()=>e:Tangular.compile(e)),n.app.cache[t]):i},e.error=function(e){var t=this.config;console.error(b,this.component.name+' - '+t.name+(t.path?' ({0})'.format(t.path):''),e)},e.clone=function(e){return e='object'!=typeof e||!e||e instanceof Date?e:CLONE(e)},e.set=function(e,t,n,i){var o,r,s,a=this,c=!1;switch(e){case'disabled':case'modified':case'readonly':case'touched':c=!0,t=!!t;break;case'invalid':c=!0}if('touched'===e&&a.check(),a.state.noemitsomething||((s=a.cache.something)?a.cache.something.changes[e]=1:((s=a.cache.something=new p).id=a.id,s.instance=a,s.state=a.state,s.element=a.element,s.changes={},s.changes[e]=1,s.kind=n,setTimeout(e=>e.app.emitstate(e.cache.something,'something'),222,a))),'force'!==n&&(null==t||'object'!=typeof t)&&a.state[e]===t)return!1;if(a.state[e]=t,a.events.set&&a.emit('set',e,t,n),a.change(),'value'===e){if(a.events.value&&a.emit('value',t,n),a.binded)for(var l of a.binded)l!==i&&(o=a.clone(t),l.state.notify?l.emit('notify',o,a):l.set('value',o,i?'noemitstate':'',a));a.binder&&a.binder!==i&&(r=a.clone(t),a.binder.state.notify?a.binder.emit('notify',r,a):a.binder.set('value',r,i?'noemitstate':'',a)),a.check()}return'noemitstate'!==n?(c&&a.element.tclass('UI_'+e,!!t),a.state.noemitstate||((s=a.cache.state)?a.cache.state.changes[e]=1:((s=a.cache.state=new p).id=a.id,s.instance=a,s.state=a.state,s.element=a.element,s.changes={},s.changes[e]=1,s.kind=n,setTimeout(e=>e.app.emitstate(e.cache.state),a.state.delay,a))),!0):void 0},e.input=function(e,t){return this.$inputs[e]=t,this},e.output=function(e,t){var n=this,i=(n.outputs||n.component.outputs||EMPTYARRAY).findItem('id',e);if(i)return void 0!==t?'function'==typeof t?n.$outputs[e]=t:o(n,i,null,t):(t=n.$outputs[e])&&t((e,t)=>o(n,i,e,t)),n;console.error(b,'Output "{0}" not found in the "{1}" component'.format(e,n.component.name))},e.family=function(e){var n=[],i=function(e){if(e.children)for(var t of e.children)n.push(t),t.component.scope||i(t)};if(null!=e){'object'==typeof e&&(e=ATTRD(e,'index'));e=this.containers?this.containers['container'+e]:null;if(e)for(var t of e)n.push(t),i(t)}else i(this);return n},e.remove=function(){this.element.remove(),this.app.clean()},e.readvalue=function(e){return e?(e=this.find(e))?e.state.value:null:this.state.value},e.view=function(e,t,n){return e&&('function'==typeof t&&(n=t,t=null),'#'===e.charAt(0)&&(e=e.substring(1)),this.app.view(e,t,n)),this},e.datasource=function(e,t){var n,i,o=this;return e&&(n=function(e){e&&(e=!(e instanceof Array)&&e.items instanceof Array?e.items:e)instanceof Array&&t(CLONE(e))},'#'===(i=e.charAt(0))?o.view(e,null,t):'@'===i?(i=o.find(e))&&(i.on('value',n),n(i.state.value)):o.clfind(e,n)),o},e.clfind=function(t,n,i){var o=this;if('function'==typeof n&&(i=n,n=''),!i)return new Promise(e=>o.app.clfind(t,n,e));var e=t.charAt(0);if('#'===e)o.view(t,{search:n},function(e){e?(e.items instanceof Array&&(e=e.items),i(e)):i([])});else{if('@'!==e)return o.app.clfind(t,n,i),o;e=o.find(t);if(e&&e.state.value instanceof Array){var r,s=[];n=n&&n.toSearch();for(r of e.state.value)!r.name||n&&-1===r.name.toSearch().indexOf(n)||s.push(r);i(s)}else i([])}},e.clread=function(t,n,i){var o=this;if(!i)return new Promise(e=>o.app.clread(t,n,e));var e=t.charAt(0);if('#'===e)o.view(t,{id:n},function(e){e?(e=e.items instanceof Array?e.items:e)instanceof Array?i(e.findItem('id',n)):i(e):i(null)});else{if('@'!==e)return o.app.clread(t,n,i),o;(e=o.find(t))&&e.state.value instanceof Array?i(e.state.value.findItem('id',n)):i(null)}},e.find=function(e){return this.app.find(e)},e.hidden=function(){return HIDDEN(this.dom)},e.reset=function(){return this.events.reset&&this.emit('reset'),this},e.reconfigure=function(e){var t=this,n={};if(e)for(var i in e){var o=t.config[i],r=e[i];r!==o&&(n[i]=o,t.config[i]=r)}if(t.events.configure&&t.emit('configure',n),g.editor){for(var s of t.app.instances)s.events.refresh&&s.emit('refresh',{type:'configure',item:t});t.app.clean()}return t},e.get=function(e){return this.state[e||'value']},e.on=function(e,t){var n;for(n of e.split(/\+|\s/).trim())this.events[n]?this.events[n].push(t):this.events[n]=[t]},e.off=function(e,t){var n;for(n of e.split(/\+|\s/).trim()){var i,o=this.events[n];o&&(t?-1!==(i=o.indexOf(t))&&(o.splice(i,1),o.length||delete this.events[n]):delete this.events[n])}return this},e.emit=function(e,t,n,i,o,r){e=this.events[e];if(e)for(var s of e)s.call(this,t,n,i,o,r)},g.makeimage=e.makeimage=function(e,t,n){var i=document.createElement('CANVAS'),e=(i.width=e,i.height=t,i.getContext('2d'));return e.fillStyle=n||'#D91500',e.fillRect(0,0,i.width,i.height),i.toDataURL('image/png')},e.bindable=function(e){return(!this.config.path||'@'!==this.config.path.charAt(0))&&this.config.path===e},e.write=function(e,t,n){if(!t||'@'===t.charAt(0))return n;for(var i=t.split('.'),o=0;o<i.length-1;o++){var r=e[i[o]];e=r=null==r?e[i[o]]={}:r}return e[i[o]]=n,e},e.include=function(o,d,r){var m=this,h=[];return(d.import||EMPTYARRAY).wait(function(e,t){g.cache[e]?t():(g.cache[e]=1,'/'===e.charAt(0)&&(e=(g.origin||'')+e),IMPORT(e,t))},function(){var p=Object.keys(d.components);p.wait(function(c,l){if(m.app.components[c])l();else{var e=d.components[c];if('string'==typeof e)if('@'===e||'#'===e)g.components[c]?m.app.pending.push({name:c,fn:g.components[c],local:!0}):console.error(b,'The component "{0}" not found.'.format(c)),l();else{var f,u=((t=e.split(' '))[1]||'').trim(),t=t[0].trim();if(u||(u=t,t=''),'base64'===(t=t&&'.'===t.charAt(0)?t.substring(1):t))try{var n=g.parsehtml(decodeURIComponent(atob(u))),i={};if(i.id=c,i.cls=m.app.class+'_'+HASH(i.id).toString(36),n.css&&(i.css=n.css),n.html&&(i.html=n.html.replace(v,i.cls)),new Function('exports',n.js.replace(v,i.cls))(i),i.components)for(var o in i.components)d.components[o]||(d.components[o]=i.components[o],p.push(o));h.push({name:c,fn:i})}finally{l()}else t&&'html'!==t&&'json'!==t||('@'===u.charAt(0)&&(u=u.substring(1)),f=(u=g.editor&&'/'===u.charAt(0)?(g.origin||'')+u:u).format(c),AJAX('GET '+f+(g.cachecomponents?' <{0}>'.format(1==g.cachecomponents?'session':g.cachecomponents):''),function(e,t){if(t)console.error(b,u,t),l();else if(ERROR(e))console.error(b,u,e),l();else if('object'==typeof e){var n=y(tmp);for(s in e){var i=e[s];'/'===i.charAt(0)&&(i=n+i),d.components[s]||(d.components[s]='@'+i,p.push(s))}l()}else{var t='@'===e.charAt(0),o=(t&&(e=e.substring(1)),g.parsehtml(e));try{var r={};if(r.id=c,r.isexternal=t,r.cls=m.app.class+'_'+HASH(r.id).toString(36),o.css&&(r.css=o.css),o.readme&&(r.readme=o.readme),o.html&&(r.html=o.html.replace(v,r.cls)),o.settings&&(r.settings=o.settings.replace(v,r.cls)),new Function('exports',o.js.replace(v,r.cls))(r),r.components)for(var s in r.components)d.components[s]||(d.components[s]=r.components[s],p.push(s));var a=u.indexOf('/',10);-1!==a&&(r.origin=u.substring(0,a),g.origin!==r.origin)&&(r.render&&'/'===r.render.charAt(0)&&(r.render=r.origin+r.render),r.settings)&&'/'===r.settings.charAt(0)&&(r.settings=r.origin+r.settings),'auto'===r.render&&(r.render=f.replace('editor.html','render.html')),'auto'===r.settings&&(r.settings=f.replace('editor.html','settings.html')),h.push({name:c,fn:r})}finally{l()}}}))}else h.push({name:c,fn:e}),l()}},function(){var e=h.splice(0),i=[];e.wait(function(e,t){var n=null;'function'==typeof e.fn?((n={}).id=e.name,n.cls=(e.local?'uibuilder':m.app.class)+'_'+HASH(n.id).toString(36),e.fn(n)):n=e.fn,m.app.components[e.name]=n,!e.local&&(n.css&&i.push(n.css.replace(v,n.cls)),n.import instanceof Array)?n.import.wait(function(e,t){g.cache[e]?t():(g.cache[e]=1,'/'===e.charAt(0)&&(e=(g.origin||'')+e),IMPORT(e,t))},t):t()},function(){var e;d.css&&i.unshift(d.css.replace(v,m.app.class)),i.length&&(e=m.app.class+'_'+GUID(5),CSS(i.join('\n'),e),m.removecss||(m.removecss=[]),m.removecss.push(e));for(var t,n=0;n<d.children.length;n++)for(t of d.children[n])m.app.compile(o,t,n);r&&r()})},3)}),m},e.watch=function(e,t,n){'function'==typeof t&&(n=t,t='value');e=this.find(e);return e&&e.on(t,n),this},e.read=function(e,t){if(t&&'@'!==t.charAt(0))for(var n=t.split('.'),i=0;i<n.length;i++)if(!(e=e[n[i]]))return e;return e},e.replace=e.variables=function(e,o,r){var s=this;return e.replace(/\{[a-z0-9_.-]+\}/gi,function(e){var t=e.substring(1,e.length-1).trim(),n='',i=t.substring(0,4);if('user'===i)W.user&&(n=-1===(t=t.substring(5)).indexOf('.')?W.user[t]:s.read(W.user,t));else if('args'===i)t=t.substring(5),n=s.args[t];else if('data'===i)o&&(n=-1===(t=t.substring(4)).indexOf('.')?o:s.read(o,t.substring(1)));else if('query'===t.substring(0,5)){if(-1===(t=t.substring(5)).indexOf('.'))return QUERIFY(s.query).substring(1);n=s.query[t.substring(1)]}else if('config'===t.substring(0,6)){if(-1===(t=t.substring(6)).indexOf('.'))return QUERIFY(s.config).substring(1);n=s.config[t.substring(1)]}if(null==n)return e;if('function'==typeof r)return r(n);switch(r){case'url':case'urlencode':case'encode':return encodeURIComponent(n);case'escape':case'html':return Thelpers.encode(n);case'json':return JSON.stringify(n)}return n})},e.wait=function(e,t){function n(){e()?t():setTimeout(n,300)}return n(),this},e.querify=function(e,t){return this.app.urlify(this.variables(t?QUERIFY(e,t):e))},e.urlify=function(e){return this.app.urlify(this.variables(e))},e.settings=function(){this.app.emit('settings',this),g.emit('settings',this)},g.version=1.23,g.selectors={component:'.UI_component',components:'.UI_components'},g.current='default',g.events={},g.apps={},g.cache={},g.components={},g.loader=0,g.component=function(e,t,n){var i,o;r&&clearTimeout(r),null==t&&'string'==typeof e&&(t=e,e=null),'string'==typeof t?(i={},e&&(i.id=e,i.cls='uibuilder_'+HASH(i.id).toString(36)),o=g.parsehtml('base64 '===t.substring(0,7)?decodeURIComponent(atob(t.substring(7))):t),new Function('exports',o.js.replace(v,i.cls))(i),t=i,o.css&&(t.css=o.css),o.html&&(t.html=o.html)):'function'==typeof e?(e(t={}),e=t.id):'function'==typeof t&&(t(t={id:e}),e=t.id),t.id||(t.id=e),t.cls||(t.cls='uibuilder_'+HASH(t.id).toString(36)),t.css&&(t.css=t.css.replace(v,t.cls)),t.html&&(t.html=t.html.replace(v,t.cls)),t.import instanceof Array?(g.loader++,t.import.wait(function(e,t){g.cache[e]?t():(g.cache[e]=1,'/'===e.charAt(0)&&(e=(g.origin||'')+e),IMPORT(e,t))},function(){g.loader--,r&&clearTimeout(r),r=setTimeout(s,2),g.components[e]=t,n&&n(null,t)})):(r&&clearTimeout(r),g.components[e]=t,n&&n(null,t))},g.resize=function(){for(var e in g.apps){var t,e=g.apps[e],n=e.element,i={width:n.width(),height:n.height(),display:WIDTH(n)};for(t of e.instances)t.events.resize&&t.emit('resize',i)}},ON('resize + resize2',g.resize),g.on=function(e,t){this.events[e]?this.events[e].push(t):this.events[e]=[t]},g.emit=function(e,t,n,i,o,r){e=this.events[e];if(e)for(var s of e)s.call(this,t,n,i,o,r)},g.register=function(e,t){g.apps[g.current].pending.push({name:e,fn:t})};var k=function(e,t){var n=e.element,i=[];for(n of n.find(g.selectors.component+'[data-id="{0}"] {1}'.format(t,g.selectors.components)))(n=$(n)).closest(g.selectors.component).attrd('id')===t&&i.push({index:+n.attrd('index'),element:n});return i.quicksort('index'),i};function x(e,t,n,i,o,r,s){if('string'==typeof n){if(!this.components[n])return void console.error(b,'The component "{0}" not found'.format(n));n={id:'cid'+Date.now().toString(36),component:n,children:[],config:n.config||{},gap:0!=n.gap}}if(r&&COPY(r,n),o)for(var a in o)n.config[a]=o[a];r=k(this,e);if(r.length)for(var c of r)c.index==t&&this.compile(c.element,n,t,i,null,s);return this.refreshio(),n}g.build=function(e,d,i){var t,a,m,o,c,l,n;if('string'==typeof d&&(d=PARSE(d)),g.loader)setTimeout(g.build,100,e,d,i);else if(g.apps[d.id])g.remove(d.id),setTimeout(g.build,100,e,d,i);else{if(d.components&&d.children)return g.current=d.id,t=document.createElement('DIV'),(a=$(t)).attrd('id',d.id),a.aclass('UI_app invisible'),a.empty(),$(e)[0].appendChild(t),o=[],(m={}).id=g.current,m.components={},m.args=d.args||{},m.query=d.query||CLONE(NAV.query),m.schema=d,m.events={},m.cache={},m.refs={},m.compile=h,m.stringify=O,m.clean=A,m.add=x,m.remove=()=>g.remove(m.id),m.class='ui_'+HASH(g.current).toString(36),m.element=a,m.dom=a[0],m.pending=[],m.instances=[],m.removecss=[],d.urlify?m.urlify=d.urlify:m.urlify=e=>e,a.aclass(m.class),m.view=function(e,t,n){g.view?g.view.call(m,e,t,n):n(EMPTYARRAY)},g.clfind?m.clfind=g.clfind:m.clfind=function(e,t,n){n(EMPTYARRAY)},g.clread?m.clread=g.clread:m.clread=function(e,t,n){n(EMPTYOBJECT)},m.on=u.prototype.on,m.find=u.prototype.find,m.emit=u.prototype.emit,m.emitstate=u.prototype.emitstate,m.intervalcounter=0,m.interval&&clearInterval(m.interval),m.interval=setInterval(function(t){if(W.inDOM(t.dom)){t.intervalcounter++;var e,n=e=>e.events.service&&e.emit('service',t.intervalcounter);for(e of t.instances)e.events.service&&e.emit('service',t.intervalcounter),e.fork&&c(e,n)}else t.remove()},6e4,m),m.recompile=function(){m.clean();for(var e,t=0;t<m.schema.children.length;t++)for(e of m.schema.children[t])e.protected=!0,m.compile(m.element,e,t)},m.build=function(e,t,n){t.urlify=m.urlify,g.build(e,t,n)},c=function(e,t){for(var n of e.fork.instances)t(n),n.fork&&c(n,t)},l=null,n=function(){if(l=null,g.editor){m.inputs=[],m.outputs=[],m.list=[],m.zindex=1;for(var e of m.instances)if(e.dom.parentNode){var t=e.component,n=(t.floating&&(m.zindex=(e.element.css('z-index')||'').parseInt(),m.zindex<=0)&&(m.zindex=1),e.inputs||t.inputs),i=e.config.name||t.name;if(m.list&&m.list.push({id:e.id,componentid:t.id,name:i,icon:t.icon,color:t.color}),n)for(var o of n)m.inputs.push({id:e.id+'_'+o.id,ref:o.id,name:i+(1<n.length?': '+o.name:''),componentid:t.id,component:t.name,input:o.name,icon:t.icon,color:t.color,note:o.note,schema:o.schema});if((n=e.outputs||t.outputs)&&n.length)for(var o of n)m.outputs.push({id:e.id+'_'+o.id,ref:o.id,name:i+(1<n.length?': '+o.name:''),componentid:t.id,component:t.name,output:o.name,icon:t.icon,color:t.color,note:o.note,schema:o.schema})}}if(!m.ready){m.ready=!0,m.callback&&m.callback(m),a.rclass('invisible'),f(m);function r(e){e.state.init=1,e.events.ready&&e.emit('ready')}var s;for(s of m.instances)s.fork&&c(s,r),s.state.init=1,s.events.ready&&s.emit('ready');g.emit('app',m),m.emit('ready')}m.emit('io',m),g.emit('io',m)},m.refreshio=function(e){e?n():(l&&clearTimeout(l),l=setTimeout(n,100))},m.input=function(e,t,n){n=n||NOOP;var i=e.indexOf('_'),o=e.substring(0,i),e=e.substring(i+1),i=m.instances.findItem('id',o);i?(i=i.$inputs[e])?i(t,n):n('Input "{0}" not found'.format(e)):n('Instance "{0}" not found'.format(o))},m.output=function(e){i=i||NOOP;var t=e.indexOf('_'),n=e.substring(0,t),e=e.substring(t+1),t=m.instances.findItem('id',n);t?t.output(e):i('Instance "{0}" not found'.format(n))},g.apps[g.current]=m,(d.import||EMPTYARRAY).wait(function(e,t){g.cache[e]?t():(g.cache[e]=1,'/'===e.charAt(0)&&(e=(g.origin||'')+e),IMPORT(e,t))},function(){var p=Object.keys(d.components);p.wait(function(a,c){var e=d.components[a];if('string'==typeof e)if('@'===e||'#'===e)g.components[a]?m.pending.push({name:a,fn:g.components[a],local:!0}):console.error(b,'The component "{0}" not found.'.format(a)),c();else{var l,f,u=((t=e.split(' '))[1]||'').trim(),t=t[0].trim();if(u||(u=t,t=''),'base64'===(t=t&&'.html'===t.charAt(0)?t.substring(1):t))try{var n={},i=(n.id=a,n.cls=m.class+'_'+HASH(n.id).toString(36),g.parsehtml(decodeURIComponent(atob(u))));if(i.css&&(n.css=i.css),i.readme&&(n.readme=i.readme),i.html&&(n.html=i.html.replace(v,n.cls)),i.settings&&(n.settings=i.settings.replace(v,n.cls)),new Function('exports',i.js.replace(v,n.cls))(n),n.components)for(var o in n.components)d.components[o]||(d.components[o]=n.components[o],p.push(o));m.pending.push({name:a,fn:n})}finally{c()}else t&&'html'!==t||((l='@'===u.charAt(0))&&(u=u.substring(1)),f=(u=g.editor&&'/'===u.charAt(0)?(g.origin||'')+u:u).format(a),AJAX('GET '+f+(g.cachecomponents?' <{0}>'.format(1==g.cachecomponents?'session':g.cachecomponents):''),function(e,t){if(t)console.error(b,f,t),c();else if(ERROR(e))console.error(b,f,e),c();else if(e)if('object'==typeof e){var n=y(f);for(r in e){var i=e[r];'/'===i.charAt(0)&&(i=n+i),d.components[r]||(d.components[r]='@'+i,p.push(r))}c()}else{t=g.parsehtml(e);try{var o={};if(o.id=a,o.isexternal=l,o.cls=m.class+'_'+HASH(o.id).toString(36),t.css&&(o.css=t.css),t.readme&&(o.readme=t.readme),t.html&&(o.html=t.html.replace(v,o.cls)),t.settings&&(o.settings=t.settings.replace(v,o.cls)),new Function('exports',t.js.replace(v,o.cls))(o),o.components)for(var r in o.components)d.components[r]||(d.components[r]=o.components[r],p.push(r));var s=u.indexOf('/',10);-1!==s&&(o.origin=u.substring(0,s),g.origin!==o.origin)&&(o.render&&'/'===o.render.charAt(0)&&(o.render=o.origin+o.render),o.settings)&&'/'===o.settings.charAt(0)&&(o.settings=o.origin+o.settings),'auto'===o.render&&(o.render=f.replace('editor.html','render.html')),'auto'===o.settings&&(o.settings=f.replace('editor.html','settings.html')),m.pending.push({name:a,fn:o})}finally{c()}}else console.error(b,f,'empty file'),c()}))}else m.pending.push({name:a,fn:e}),c()},function(){m.pending.splice(0).wait(function(e,t){var n=null;'function'==typeof e.fn?((n={}).id=e.name,n.cls=(e.local?'uibuilder':m.class)+'_'+HASH(n.id).toString(36),e.fn(n)):n=e.fn,m.components[e.name]=n,!e.local&&(n.css&&o.push(n.css.replace(v,n.cls)),n.import instanceof Array)?n.import.wait(function(e,t){g.cache[e]?t():(g.cache[e]=1,'/'===e.charAt(0)&&(e=(g.origin||'')+e),IMPORT(e,t))},t):t()},function(){d.css&&o.unshift(d.css.replace(v,m.class)),CSS(o,m.class);for(var e,t=0;t<d.children.length;t++)for(e of d.children[t])e.protected=!0,m.compile(a,e,t);m.callback=i})},1)}),m;WARN('Invalid UI Builder metadata:',d.id)}},g.parsehtml=function(e){var t,n,i,o,r,s,a='';return-1===e.indexOf('<script>')?{js:e}:(n=s=a=t=o='',-1!==(i=e.indexOf('<settings>'))&&(r=e.indexOf('</settings>',i+10),o=e.substring(i+10,r).trim(),e=e.substring(0,i)+e.substring(r+11)),-1!==(i=e.indexOf('<style>'))&&(a=e.substring(i+7,e.indexOf('</style>',i+7))),-1!==(i=e.indexOf('<body>'))&&(n=e.substring(i+6,e.indexOf('</body>',i+6))),-1!==(i=e.indexOf('<readme>'))&&(t=e.substring(i+8,e.indexOf('</readme>',i+8))),-1!==(i=e.indexOf('<script>'))&&(r=e.indexOf('<\/script>',i+8),s=e.substring(i+8,r).trim()),{js:s,css:a,settings:o,readme:t,html:n})},g.remove=function(t){var n=g.apps[t];if(n){n.interval&&clearInterval(n.interval),n.interval=null;for(var e of n.instances){if(e.removecss)for(var i of e.removecss)CSS('',i);e.events.destroy&&e.emit('destroy')}setTimeout(function(){for(var e in n.components){e=n.components[e];e.uninstall&&e.uninstall()}n.tmp=null,CSS('',n.class),n.element.remove(),delete g.apps[t]},2)}};var d=null,T=document;function I(i,r,e){var t,n,o,s,a,c,l=(i=i instanceof jQuery?i:$(i)).closest('.UI_component')[0];!l||l.uibuilder.meta.readonly||l.uibuilder.forked||(null==(r=r||{}).format&&(r.format=!0),r.format&&null==r.icon&&(r.icon=!0),e&&(r.callback=e),d?d.element[0]!=i[0]&&(d.close(),setTimeout(I,100,i,r,e)):(r.backup=i.html(),r.html&&i.html(r.html),i.attr('contenteditable',!0),i.aclass('UI_editing'),(d={}).element=i,d.dom=i[0],d.instance=l.uibuilder,d.parent=r.parent?r.parent[0]:d.dom,r.callback||(r.callback=function(){d.instance&&d.instance.emit('html',i)}),d.createlink=function(){if(function(e){if(T.selection&&'Text'===T.selection.type)return T.selection.createRange().htmlText;if(W.getSelection){var t=W.getSelection();if(!t.rangeCount)return'';for(var n=T.createElement('div'),i=0,o=t.rangeCount;i<o;++i)n.appendChild(t.getRangeAt(i).cloneContents());return e?n:n.innerHTML}}().trim()){for(var e=d.element,t='#link'+Date.now().toString(36),n=e[0],i=0;i<5;i++){if('A'===n.tagName)return;if(!(n=n.parentNode))break}document.execCommand('CreateLink',!1,t);var o,e=e.find('a[href="'+t+'"]');e.length&&(d.instance,d&&d.close(),t=e.text(),o='',e.aclass('UI_link'),r.cms&&e.aclass('CMS_edit CMS_remove'),-1!==t.indexOf('@')?o='mailto:'+t:/\d+/.test(t)?o='tel:'+t:-1===t.indexOf(' ')&&-1===t.indexOf(',')&&-1!==t.indexOf('.')&&(o=/http(s):\/\//.test(t)?t:'https://'+t),t=-1!==o.indexOf('.')&&-1===o.indexOf(location.hostname)?'_blank':'',e.attr('href',o||'#'),e.attr('target',t),g.emit('link',e))}},t=function(){d.close()},n=function(e){e.target===d.parent||d.parent.contains(e.target)||d.close()},o=function(e){e.preventDefault();e=(e.originalEvent||e).clipboardData.getData('text/plain');document.execCommand('insertHTML',!1,e)},s=function(e){if(r.keydown&&r.keydown(e),27===e.keyCode)e.preventDefault(),e.stopPropagation(),d.key=27,d.close();else if(r.backslashremove&&8===e.keyCode&&!i.text().trim())d.key=8,d.close();else if(13===e.keyCode)r.multiline&&!e.shiftKey||(e.preventDefault(),e.stopPropagation(),d.key=13,d.close());else{if(9===e.keyCode)return r.tabs?(e.preventDefault(),void document.execCommand('insertHTML',!1,'&#009')):(r.endwithtab?(e.preventDefault(),d.key=9):(e.preventDefault(),e.stopPropagation()),void d.close());var t,n;d.change=!0,(e.metaKey||e.ctrlKey)&&(66===e.keyCode?r.format&&!1!==r.bold||(e.preventDefault(),e.stopPropagation()):76===e.keyCode?(e.preventDefault(),e.stopPropagation(),r.format&&!1!==r.link&&d.createlink()):73===e.keyCode?r.format&&!1!==r.italic||(e.preventDefault(),e.stopPropagation()):80===e.keyCode?(r.format&&!0===r.icon&&(t=i[0].nodeName.toLowerCase(),n='<i class="ti ti-totaljs UI_icon'+(r.cms?' CMS_edit CMS_remove':'')+'" contenteditable="false"></i>','span'===t?i.parent().prepend(n):document.execCommand('insertHTML',!1,n)),e.preventDefault(),e.stopPropagation()):85===e.keyCode?r.format&&!1!==r.underline||(e.preventDefault(),e.stopPropagation()):32===e.keyCode&&(document.execCommand('insertHTML',!1,'&nbsp;'),e.preventDefault(),e.stopPropagation()))}},i.focus(),'end'===r.cursor&&((e=document.createRange()).selectNodeContents(i[0]),e.collapse(!1),(l=W.getSelection()).removeAllRanges(),l.addRange(e)),d.close=function(){var e;$(W).off('click',n),i.rattr('contenteditable'),i.off('keydown',s),i.off('contextmenu',t),i.off('paste',o),i.rclass('UI_editing'),r.callback&&((e={}).text=i.text().trim(),e.html=i.html(),e.change=d.change,e.element=d.element,e.dom=d.dom,e.backup=r.backup,e.key=d.key,e.param=r.param,e.instance=d.instance,r.callback(e)),d.timeout&&clearTimeout(d.timeout),d=null},a=r.placeholder,c=!1,d.checkplaceholder=function(){var e;a&&(e=0<i[0].innerHTML.length,c!==e)&&(c=e,a.classList.toggle('hidden',e))},$(W).on('click',n),i.on('keydown',s),i.on('contextmenu',t),r.placeholder&&a&&i.on('input',d.checkplaceholder),i.on('paste',o)))}function O(e,u){var t,p=this,d='function'==typeof e?e:null,n=(e=d?null:e)||p.element.find('> '+g.selectors.component),i=[],m=[],h={};for(t of n){var o={children:[]};i.push(o),!function e(t,n){var i,o,r,s=n.uibuilder;if(t.id=n.getAttribute('data-id'),t.component=s.component.id,t.config=CLONE(s.config),h[s.component.id]||(i=p.schema.components[s.component.id])&&(h[s.component.id]=i),s.component.floating&&(o=(i=$(n)).position(),t.x=o.left,t.y=o.top,t.zindex=i.css('z-index')||m.length,t.zindex=+t.zindex,t.zindex<=0)&&(t.zindex=1),!d||d(t)){if(m.push(s),n.classList.contains('UI_gap')&&(t.gap=!0),s.children=[],!s.component.children)for(r of k(p,t.id)){var a,c=[],l=r.element.find('> '+g.selectors.component);t.children||(t.children=[]),t.children.push(c);for(a of l){var f={children:[]};c.push(f),s.children.push(a.uibuilder),e(f,a)}}s.events.stringify&&s.emit('stringify',t,u)}}(o,t)}i=e?i[0]:[i];return{instances:m,children:i,components:h}}g.edit=I}(W.UIBuilder={});